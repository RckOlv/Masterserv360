<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">

      <div class="text-center mb-4 p-4 rounded shadow-sm" style="background: #1a1a1a; border-bottom: 3px solid #E41E26;">
        <img src="/images/Masterserv.png" alt="Masterserv Logo" height="50" class="mb-2 bg-white rounded p-1">
        <h2 class="text-white mb-0">Solicitud de Cotización</h2>
        <small class="text-secondary">Portal de Proveedores</small>
      </div>

      <div *ngIf="isLoading" class="text-center p-5">
        <div class="spinner-border text-danger" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 text-white">Cargando solicitud...</p>
      </div>

      <div *ngIf="errorMessage && !isLoading" class="alert alert-danger text-center shadow">
        <h4><i class="bi bi-x-circle-fill me-2"></i> Enlace no válido</h4>
        <p>{{ errorMessage }}</p>
      </div>

      <div *ngIf="isSuccess" class="alert alert-success text-center p-5 shadow">
        <h1 class="display-4"><i class="bi bi-check-circle-fill"></i></h1>
        <h2>¡Oferta Enviada!</h2>
        <p class="lead">Gracias, <strong>{{ cotizacion?.proveedorNombre }}</strong>.</p>
        <p>Hemos recibido su cotización correctamente.</p>
      </div>

      <div *ngIf="cotizacion && !isLoading && !errorMessage && !isSuccess">
        <form [formGroup]="form" (ngSubmit)="onSubmit()">
          
          <div class="card masterserv-card mb-4" style="background-color: #1E1E1E; border: 1px solid #333;">
            <div class="card-body text-white">
              <div class="row">
                <div class="col-md-6">
                  <span class="text-secondary d-block">Proveedor:</span>
                  <strong class="fs-5 text-white">{{ cotizacion.proveedorNombre }}</strong>
                </div>
                <div class="col-md-6 text-md-end">
                  <span class="text-secondary d-block">Fecha Solicitud:</span>
                  <strong class="text-white">{{ cotizacion.fechaSolicitud | date:'dd/MM/yyyy' }}</strong>
                </div>
              </div>
              
              <div class="row justify-content-end mt-4">
                  <div class="col-auto">
                      <label class="form-label text-white fw-bold me-3">Fecha de Entrega Estimada: <span class="text-danger">*</span></label>
                  </div>
                  <div class="col-auto">
                      <input type="date" class="form-control bg-dark text-white border-secondary"
                             formControlName="fechaEntregaOfertada"
                             [min]="minDate"
                             [class.is-invalid]="f['fechaEntregaOfertada']?.invalid && f['fechaEntregaOfertada']?.touched">
                      
                      <div *ngIf="f['fechaEntregaOfertada']?.errors?.['required'] && f['fechaEntregaOfertada']?.touched" 
                           class="text-danger small mt-1">
                          Fecha requerida.
                      </div>
                      <div *ngIf="f['fechaEntregaOfertada']?.errors?.['fechaPasada']" 
                           class="text-danger small mt-1">
                          La fecha no puede ser anterior a hoy.
                      </div>
                  </div>
              </div>

            </div>
          </div>

          <div class="card masterserv-card shadow" style="background-color: #1E1E1E; border: 1px solid #333;">
            <div class="card-header border-bottom border-secondary" style="background-color: #252525;">
              <h5 class="mb-0 text-white"><i class="bi bi-box-seam me-2"></i>Detalle de Productos</h5>
            </div>
            
            <div class="table-responsive">
              <table class="table table-dark table-hover mb-0 align-middle">
                <thead class="text-secondary" style="border-bottom: 2px solid #E41E26;">
                  <tr>
                    <th>Producto</th>
                    <th style="width: 130px;" class="text-center">Solicitado</th>
                    <th style="width: 160px;">Su Oferta (Cant)</th>
                    <th style="width: 180px;">Precio Unitario</th>
                    <th style="width: 80px;" class="text-center">Disp.</th>
                  </tr>
                </thead>
                <tbody formArrayName="items">
                  <tr *ngFor="let itemGroup of itemsFormArray.controls; let i = index" [formGroupName]="i"
                      [class.table-active]="!itemGroup.get('disponible')?.value">
                    
                    <td>
                      <span [class.text-decoration-line-through]="!itemGroup.get('disponible')?.value"
                            [class.text-muted]="!itemGroup.get('disponible')?.value"
                            class="fw-bold d-block">
                        {{ itemGroup.get('productoNombre')?.value }}
                      </span>
                      <small class="text-secondary">{{ itemGroup.get('productoCodigo')?.value }}</small>
                    </td>

                    <td class="text-center">
                        <span class="badge bg-secondary fs-6">{{ itemGroup.get('cantidadSolicitada')?.value }}</span>
                    </td>

                    <td>
                      <input type="number" class="form-control form-control-sm bg-dark text-white border-secondary"
                             formControlName="cantidadOfertada"
                             min="1"
                             [attr.disabled]="!itemGroup.get('disponible')?.value ? true : null"
                             [class.is-invalid]="itemGroup.get('cantidadOfertada')?.invalid && itemGroup.get('cantidadOfertada')?.touched">
                      
                      <div *ngIf="itemGroup.get('cantidadOfertada')?.invalid && itemGroup.get('cantidadOfertada')?.touched" class="text-danger small mt-1" style="line-height: 1.2;">
                           <div *ngIf="itemGroup.get('cantidadOfertada')?.errors?.['required']">Requerido</div>
                           <div *ngIf="itemGroup.get('cantidadOfertada')?.errors?.['min']">Mínimo 1</div>
                           <div *ngIf="itemGroup.get('cantidadOfertada')?.errors?.['max']">
                               Máximo {{ itemGroup.get('cantidadSolicitada')?.value }}
                           </div>
                      </div>
                    </td>

                    <td>
                      <div class="input-group input-group-sm">
                        <span class="input-group-text bg-dark border-secondary text-secondary">$</span>
                        <input type="number" class="form-control bg-dark text-white border-secondary"
                               placeholder="0.00"
                               formControlName="precioUnitarioOfertado"
                               [attr.disabled]="!itemGroup.get('disponible')?.value ? true : null"
                               [class.is-invalid]="itemGroup.get('precioUnitarioOfertado')?.invalid && itemGroup.get('precioUnitarioOfertado')?.touched">
                      </div>
                      <div *ngIf="itemGroup.get('precioUnitarioOfertado')?.invalid && itemGroup.get('precioUnitarioOfertado')?.touched"
                           class="text-danger small mt-1">
                        Requerido
                      </div>
                    </td>

                    <td class="text-center">
                        <div class="form-check form-switch d-flex justify-content-center">
                            <input class="form-check-input" type="checkbox" role="switch"
                                   formControlName="disponible"
                                   (change)="toggleDisponibilidad(i)">
                        </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="card-footer border-0 text-end p-3" style="background-color: #252525;">
              <button type="submit" class="btn btn-danger btn-lg px-5 fw-bold" 
                      [disabled]="form.invalid || isSubmitting">
                <span *ngIf="!isSubmitting"><i class="bi bi-send-fill me-2"></i> Confirmar Oferta</span>
                <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm"></span>
              </button>
            </div>

          </div>
        </form>
      </div> 
    </div>
  </div>
</div>