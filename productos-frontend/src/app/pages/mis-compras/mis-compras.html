<div class="container compras-container">
  
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-white fw-bold mb-0">
      <i class="bi bi-bag-check-fill me-2 text-danger"></i>Mis Compras
    </h2>
    <span class="badge bg-dark border border-secondary text-white-50" *ngIf="page">
      {{ page.totalElements }} compras
    </span>
  </div>

  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-danger" role="status" style="width: 3rem; height: 3rem;"></div>
  </div>

  <div *ngIf="!isLoading && (!page || page.totalElements === 0)" class="text-center py-5">
    <i class="bi bi-cart-x display-1 text-muted mb-3"></i>
    <h4 class="text-white">Aún no has realizado ninguna compra.</h4>
    <p class="text-white-50">¡Explora nuestro catálogo y encuentra lo que necesitas!</p>
    <a routerLink="/portal/catalogo" class="btn btn-danger mt-3">Ir al Catálogo</a>
  </div>

  <div class="table-responsive" *ngIf="!isLoading && page?.content?.length">
    <table class="table table-dark table-hover align-middle mb-0" style="border: 1px solid #333; border-radius: 8px; overflow: hidden;">
      <thead style="background-color: #1e1e1e; border-bottom: 2px solid #dc3545;">
        <tr>
          <th scope="col" class="text-white py-3 ps-4">ID Venta</th>
          <th scope="col" class="text-white py-3">Fecha</th>
          <th scope="col" class="text-white py-3 text-center">Productos</th>
          <th scope="col" class="text-white py-3 text-end">Total</th>
          <th scope="col" class="text-white py-3 text-center">Estado</th>
          <th scope="col" class="text-white py-3 text-center pe-4">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let venta of page!.content" style="border-bottom: 1px solid #333;">
          <td class="ps-4 fw-bold text-white">#{{ venta.id }}</td>
          <td class="text-white-50">{{ venta.fechaVenta | date:'dd/MM/yyyy' }}</td>
          <td class="text-center">
            <span class="badge bg-dark border border-secondary text-white-50">
              <i class="bi bi-box-seam me-1"></i> {{ venta.cantidadItems }}
            </span>
             <span *ngIf="venta.codigoCuponUsado" class="badge bg-dark border border-warning text-warning ms-2" title="Cupón usado">
              <i class="bi bi-tag-fill"></i>
            </span>
          </td>
          <td class="text-end text-success fw-bold">{{ venta.totalVenta | currency:'ARS':'symbol':'1.0-0' }}</td>
          <td class="text-center">
            <span class="badge"
                  [ngClass]="venta.estado === 'COMPLETADA' ? 'bg-success-subtle text-success border border-success' : 'bg-danger-subtle text-danger border border-danger'">
              {{ venta.estado }}
            </span>
          </td>
          <td class="text-center pe-4">
            <div class="btn-group" role="group">
              <button class="btn btn-outline-light btn-sm" (click)="verDetalle(venta.id)" title="Ver Detalles">
                <i class="bi bi-eye"></i>
              </button>
              <button *ngIf="venta.estado === 'COMPLETADA'" 
                      class="btn btn-dark btn-sm border-secondary text-danger" 
                      title="Descargar Comprobante"
                      (click)="descargarComprobante(venta.id, $event)">
                <i class="bi bi-file-earmark-pdf-fill"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top border-secondary" 
       *ngIf="!isLoading && page && page.totalElements > 0">
    
    <button class="btn btn-outline-light btn-sm" (click)="paginaAnterior()" [disabled]="page.first">
      <i class="bi bi-chevron-left"></i> Anterior
    </button>

    <span class="text-white-50 small">
      Página <strong class="text-warning">{{ page.number + 1 }}</strong> de <strong class="text-white">{{ page.totalPages }}</strong>
      <span class="d-none d-md-inline text-light"> (Total: {{ page.totalElements }} compras)</span>
    </span>

    <button class="btn btn-outline-light btn-sm" (click)="paginaSiguiente()" [disabled]="page.last">
      Siguiente <i class="bi bi-chevron-right"></i>
    </button>

  </div>

</div>

<div class="modal fade" id="modalDetalleCompra" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content modal-content-dark">
      
      <div class="modal-header modal-header-dark">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-info-circle me-2 text-danger"></i>Detalle de Compra #{{ compraSeleccionada?.id }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-0">
        
        <div *ngIf="isLoadingDetalle" class="text-center py-5">
          <div class="spinner-border text-danger" role="status"></div>
        </div>

        <div *ngIf="!isLoadingDetalle && compraSeleccionada" class="table-responsive">
          <table class="table table-dark-custom mb-0 align-middle w-100">
            <thead>
              <tr>
                <th class="ps-4">Producto</th>
                <th class="text-center">Cant.</th>
                <th class="text-end">Precio U.</th>
                <th class="text-end pe-4">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of compraSeleccionada.detalles">
                <td class="ps-4">
                  <div class="fw-bold text-white">{{ item.productoNombre }}</div>
                  <small class="text-white-50 font-monospace">{{ item.productoCodigo }}</small>
                </td>
                <td class="text-center">
                    <span class="badge bg-dark border border-secondary">{{ item.cantidad }}</span>
                </td>
                <td class="text-end text-white-50">{{ item.precioUnitario | currency:'ARS':'symbol':'1.0-0' }}</td>
                <td class="text-end pe-4 fw-bold text-warning">{{ item.subtotal | currency:'ARS':'symbol':'1.0-0' }}</td>
              </tr>
            </tbody>
            <tfoot>
              <tr *ngIf="compraSeleccionada.montoDescuento && compraSeleccionada.montoDescuento > 0">
                <td colspan="3" class="text-end pe-3 text-white-50 small">
                    <i class="bi bi-tag-fill me-1"></i> Descuento <span class="font-monospace text-warning">({{ compraSeleccionada.codigoCupon }})</span>:
                </td>
                <td class="text-end pe-4 text-success fw-bold">- {{ compraSeleccionada.montoDescuento | currency:'ARS':'symbol':'1.0-0' }}</td>
              </tr>
              <tr>
                <td colspan="3" class="text-end pe-3 fs-5 text-white fw-bold">TOTAL:</td>
                <td class="text-end pe-4 fs-4 fw-bold text-danger">{{ compraSeleccionada.totalVenta | currency:'ARS':'symbol':'1.0-0' }}</td>
              </tr>
            </tfoot>
          </table>
        </div>

      </div>

      <div class="modal-footer justify-content-between border-secondary">
        <small class="text-white-50" *ngIf="compraSeleccionada">
          <i class="bi bi-calendar3 me-1"></i> {{ compraSeleccionada.fechaVenta | date:'dd/MM/yyyy HH:mm' }}
        </small>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
      </div>

    </div>
  </div>
</div>