<div class="container compras-container">
  
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-white fw-bold mb-0">
      <i class="bi bi-bag-check-fill me-2 text-danger"></i>Mis Compras
    </h2>
    <span class="badge bg-dark border border-secondary text-white-50" *ngIf="page">
      {{ page.totalElements }} ordenes
    </span>
  </div>

  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-danger" role="status" style="width: 3rem; height: 3rem;"></div>
  </div>

  <div *ngIf="!isLoading && (!page || page.totalElements === 0)" class="text-center py-5">
    <i class="bi bi-cart-x display-1 text-muted mb-3"></i>
    <h4 class="text-white">Aún no has realizado ninguna compra.</h4>
    <p class="text-white-50">¡Explora nuestro catálogo y encuentra lo que necesitas!</p>
    <a routerLink="/portal/catalogo" class="btn btn-danger mt-3">Ir al Catálogo</a>
  </div>

  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" *ngIf="!isLoading && page?.content?.length">
    
    <div class="col" *ngFor="let venta of page!.content">
      <div class="compra-card h-100 d-flex flex-column">
        
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-bold text-white">
            <i class="bi bi-receipt me-1"></i> #{{ venta.id }}
          </span>
          <span class="badge badge-estado"
                [ngClass]="venta.estado === 'COMPLETADA' ? 'bg-success-subtle' : 'bg-danger-subtle'">
            {{ venta.estado }}
          </span>
        </div>

        <div class="card-body flex-grow-1">
          <div class="row mb-3">
            <div class="col-6">
              <span class="text-label">Fecha</span>
              <span class="text-value fs-6">{{ venta.fechaVenta | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="col-6 text-end">
              <span class="text-label">Total</span>
              <span class="text-value text-success">{{ venta.totalVenta | currency:'ARS':'symbol':'1.0-0' }}</span>
            </div>
          </div>
          
          <div class="d-flex align-items-center text-white-50 small mt-2 pt-2 border-top border-secondary">
            <i class="bi bi-box-seam me-2"></i>
            <span>{{ venta.cantidadItems }} productos</span>
            <span class="mx-2">|</span>
            <span *ngIf="venta.codigoCuponUsado" class="text-warning">
              <i class="bi bi-tag-fill me-1"></i> {{ venta.codigoCuponUsado }}
            </span>
             <span *ngIf="!venta.codigoCuponUsado">Sin cupón</span>
          </div>
        </div>

        <div class="card-footer d-grid gap-2 d-flex justify-content-between">
          <button class="btn btn-outline-light btn-sm flex-grow-1" (click)="verDetalle(venta.id)">
            <i class="bi bi-eye me-1"></i> Ver Detalles
          </button>
          <button *ngIf="venta.estado === 'COMPLETADA'" 
                  class="btn btn-dark btn-sm border-secondary" 
                  title="Descargar Comprobante"
                  (click)="descargarComprobante(venta.id, $event)">
            <i class="bi bi-file-earmark-pdf text-danger"></i>
          </button>
        </div>

      </div>
    </div>
  </div>

  <div class="d-flex justify-content-center mt-5" *ngIf="!isLoading && page && page.totalElements > 0">
    <mat-paginator [length]="page.totalElements"
                   [pageSize]="page.size"
                   [pageSizeOptions]="[6, 12, 24]"
                   [pageIndex]="page.number"
                   (page)="handlePageEvent($event)"
                   aria-label="Seleccionar página">
    </mat-paginator>
  </div>

</div>

<div class="modal fade" id="modalDetalleCompra" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content modal-content-dark">
      
      <div class="modal-header modal-header-dark">
        <h5 class="modal-title fw-bold">
          <i class="bi bi-info-circle me-2 text-danger"></i>Detalle de Compra #{{ compraSeleccionada?.id }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body p-0">
        
        <div *ngIf="isLoadingDetalle" class="text-center py-5">
          <div class="spinner-border text-danger" role="status"></div>
        </div>

        <div *ngIf="!isLoadingDetalle && compraSeleccionada" class="table-responsive">
          <table class="table table-dark-custom mb-0 align-middle">
            <thead>
              <tr>
                <th class="ps-4">Producto</th>
                <th class="text-center">Cant.</th>
                <th class="text-end">Precio U.</th>
                <th class="text-end pe-4">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of compraSeleccionada.detalles">
                <td class="ps-4">
                  <div class="fw-bold text-white">{{ item.productoNombre }}</div>
                  <small class="text-white-50">{{ item.productoCodigo }}</small>
                </td>
                <td class="text-center">{{ item.cantidad }}</td>
                <td class="text-end">{{ item.precioUnitario | currency:'ARS':'symbol':'1.0-0' }}</td>
                <td class="text-end pe-4 fw-bold text-success">{{ item.subtotal | currency:'ARS':'symbol':'1.0-0' }}</td>
              </tr>
            </tbody>
            <tfoot style="border-top: 2px solid #444;">
              <tr *ngIf="compraSeleccionada.montoDescuento && compraSeleccionada.montoDescuento > 0">
                <td colspan="3" class="text-end pe-3 text-white-50">
                    Descuento <small>({{ compraSeleccionada.codigoCupon }})</small>:
                </td>
                <td class="text-end pe-4 text-danger fw-bold">- {{ compraSeleccionada.montoDescuento | currency:'ARS':'symbol':'1.0-0' }}</td>
              </tr>
              <tr>
                <td colspan="3" class="text-end pe-3 fs-5 text-white">TOTAL:</td>
                <td class="text-end pe-4 fs-4 fw-bold text-white">{{ compraSeleccionada.totalVenta | currency:'ARS':'symbol':'1.0-0' }}</td>
              </tr>
            </tfoot>
          </table>
        </div>

      </div>

      <div class="modal-footer modal-header-dark justify-content-between">
        <small class="text-white-50" *ngIf="compraSeleccionada">
          Realizada el: {{ compraSeleccionada.fechaVenta | date:'dd/MM/yyyy HH:mm' }}
        </small>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>

    </div>
  </div>
</div>