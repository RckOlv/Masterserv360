<div class="container my-4">
  <div class="row">
    <div class="col-lg-8 offset-lg-2">

      <h2 class="mb-3 text-masterserv">Mi Saldo de Puntos</h2>

      <div *ngIf="isLoadingSaldo" class="text-center p-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3">Cargando tu saldo...</p>
      </div>
      
      <ng-container *appHasPermission="'PUNTOS_READ'">
        
        <div *ngIf="!isLoadingSaldo && saldo">

          <div class="card card-masterserv mb-4 shadow">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <p class="text-metal mb-1">Puntos Disponibles</p>
                  <h1 class="display-4 fw-bold text-accent mb-0">
                    {{ saldo.saldoPuntos }}
                  </h1>
                </div>
                <div class="col-md-6 text-md-end">
                  <p class="text-metal mb-1">Equivalente en Descuento (ARS)</p>
                  <h3 class="text-white mb-0">
                    {{ saldo.valorMonetario | currency:'ARS':'symbol':'1.2-2' }}
                  </h3>
                  <small class="text-metal">*{{ saldo.equivalenciaActual }}</small>
                </div>
              </div>
            </div>
          </div>

          <div class="card card-masterserv shadow mb-4" *appHasPermission="'PUNTOS_CANJE'">
            <div class="card-header">
              Canjear mis Puntos
            </div>
            <div class="card-body">
              
              <div *ngIf="saldo.saldoPuntos === 0" class="alert alert-info">
                Actualmente no tienes puntos suficientes para realizar un canje. ¡Sigue comprando para sumar!
              </div>

              <form [formGroup]="canjeForm" (ngSubmit)="onCanjear()">
                <p>Ingresa la cantidad de puntos que deseas canjear por un cupón de descuento:</p>
                
                <div class="row g-2">
                  <div class="col-sm-8">
                    <label for="puntosACanjear" class="form-label visually-hidden">Puntos a canjear</label>
                    <input type="number" 
                            class="form-control form-control-lg" 
                            id="puntosACanjear" 
                            formControlName="puntosACanjear"
                            [class.is-invalid]="canjeForm.get('puntosACanjear')?.invalid && canjeForm.get('puntosACanjear')?.touched">
                    
                    <div *ngIf="canjeForm.get('puntosACanjear')?.invalid && canjeForm.get('puntosACanjear')?.touched"
                          class="invalid-feedback d-block">
                      <small *ngIf="canjeForm.get('puntosACanjear')?.errors?.['required']">
                        Campo requerido.
                      </small>
                      <small *ngIf="canjeForm.get('puntosACanjear')?.errors?.['min']">
                        Debe ser al menos 1 punto.
                      </small>
                      <small *ngIf="canjeForm.get('puntosACanjear')?.errors?.['max']">
                        No puedes canjear más de {{ saldo.saldoPuntos }} puntos.
                      </small>
                    </div>
                  </div>
                  
                  <div class="col-sm-4 d-grid">
                    <button type="submit" class="btn btn-masterserv-accent btn-lg" [disabled]="canjeForm.invalid || isSubmitting">
                      <span *ngIf="!isSubmitting">Canjear Ahora</span>
                      <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm" role="status"></span>
                    </button>
                  </div>
                </div>

              </form>
            </div>
          </div>

          <div *ngIf="cuponGenerado" class="alert alert-success shadow text-center p-4">
            <h4 class="alert-heading">¡Cupón Generado!</h4>
            <p>Presenta este código en tu próxima compra para obtener tu descuento:</p>
            <h3 class="fw-bold text-dark bg-light p-3 rounded border border-2 border-dark d-inline-block">
              {{ cuponGenerado.codigo }}
            </h3>
            <p class="mb-0 mt-3">
              Valor del cupón: <strong>{{ cuponGenerado.descuento | currency:'ARS':'symbol':'1.2-2' }}</strong>
              <br>
              <small>Válido hasta: {{ cuponGenerado.fechaVencimiento | date:'dd/MM/yyyy' }}</small>
            </p>
          </div>

        </div>
        </ng-container>
      
      <div *ngIf="!isLoadingSaldo && !saldo" class="alert alert-danger text-center mt-4">
        <i class="bi bi-shield-lock me-2"></i>No tienes los permisos necesarios para acceder a la información de puntos.
      </div>

    </div>
  </div>
</div>