<div class="container my-5">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">Mis Puntos</h2>
      <p class="text-muted">
        Consulta tu saldo de puntos, conoce su valor y canjéalos por cupones de
        descuento para tu próxima compra.
      </p>
      <hr class="mb-4" />
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Mi Saldo Actual</h5>
        </div>
        <div class="card-body p-4 text-center">
          
          <div *ngIf="isLoadingSaldo" class="my-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando saldo...</span>
            </div>
          </div>

          <div *ngIf="!isLoadingSaldo && saldo">
            <h1 class="display-3 fw-bold text-primary mb-3">
              {{ saldo.saldoPuntos | number }}
              <span class="fs-4 text-muted">Puntos</span>
            </h1>
            <h3 class="fw-normal text-success mb-3">
              Equivalen a:
              {{ saldo.valorMonetario | currency:'ARS':'symbol':'1.2-2' }}
            </h3>
            <p class="text-muted small">
              ({{ saldo.equivalenciaActual }})
            </p>
          </div>
          
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light">
          <h5 class="mb-0">Canjear Puntos</h5>
        </div>
        <div class="card-body p-4">
          <p class="card-text">
            Ingresa la cantidad de puntos que deseas canjear. Se generará un
            cupón de descuento que podrás usar en tu próxima compra.
          </p>

          <form [formGroup]="canjeForm" (ngSubmit)="onCanjear()">
            <fieldset [disabled]="isSubmitting || isLoadingSaldo || !saldo || saldo.saldoPuntos === 0">
              
              <div class="mb-3">
                <label for="puntosACanjear" class="form-label">Puntos a Canjear:</label>
                <input type="number" id="puntosACanjear" class="form-control form-control-lg"
                       formControlName="puntosACanjear"
                       [ngClass]="{ 'is-invalid': canjeForm.get('puntosACanjear')?.invalid && canjeForm.get('puntosACanjear')?.touched }">
                
                <div *ngIf="canjeForm.get('puntosACanjear')?.invalid && canjeForm.get('puntosACanjear')?.touched" 
                     class="invalid-feedback d-block">
                  <div *ngIf="canjeForm.get('puntosACanjear')?.errors?.['required']">
                    Debes ingresar una cantidad.
                  </div>
                  <div *ngIf="canjeForm.get('puntosACanjear')?.errors?.['min']">
                    Debe ser al menos 1 punto.
                  </div>
                  <div *ngIf="canjeForm.get('puntosACanjear')?.errors?.['max']">
                    No puedes canjear más puntos de los que tienes (Máx: {{ saldo?.saldoPuntos }}).
                  </div>
                </div>
              </div>

              <div class="d-grid">
                <button type="submit" class="btn btn-success btn-lg" 
                        [disabled]="canjeForm.invalid || isSubmitting || isLoadingSaldo">
                  <span *ngIf="!isSubmitting">
                    <i class="bi bi-gift-fill me-2"></i>Canjear Ahora
                  </span>
                  <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  <span *ngIf="isSubmitting"> Canjeando...</span>
                </button>
              </div>

            </fieldset>
            
            <div *ngIf="!isLoadingSaldo && saldo && saldo.saldoPuntos === 0" class="alert alert-warning mt-3">
              No tienes puntos suficientes para canjear.
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="cuponGenerado" class="row mt-4 justify-content-center">
    <div class="col-lg-12">
      <div class="alert alert-success shadow-sm p-4">
        <h4 class="alert-heading">
          <i class="bi bi-check-circle-fill me-2"></i>¡Canje Exitoso!
        </h4>
        <p>
          Se ha generado tu cupón de descuento. Cópialo y úsalo en tu próxima compra.
        </p>
        <hr />
        <p class="mb-0 fs-5">
          Tu código es:
          <strong class="text-success-emphasis bg-success-subtle p-2 rounded">
            {{ cuponGenerado.codigo }}
          </strong>
        </p>
        <p class="mb-0 fs-5">
          Valor del cupón:
          <strong>{{ cuponGenerado.descuento | currency:'ARS':'symbol':'1.2-2' }}</strong>
        </p>
        <p class="mb-0 text-muted">
          Válido hasta: {{ cuponGenerado.fechaVencimiento | date:'dd/MM/yyyy' }}
        </p>
      </div>
    </div>
  </div>
</div>