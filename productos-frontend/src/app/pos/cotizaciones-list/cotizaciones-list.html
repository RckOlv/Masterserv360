<div class="cotizaciones-container" *appHasPermission="'PEDIDOS_MANAGE'">
  <div class="card masterserv-card shadow-sm">
    
    <div class="card-header masterserv-card-header d-flex justify-content-between align-items-center">
      <h4 class="masterserv-title">
        <i class="bi bi-inbox-fill me-2"></i>Cotizaciones Recibidas
      </h4>
      <button class="btn masterserv-btn-secondary btn-sm" (click)="loadCotizaciones()" [disabled]="isLoading">
        <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1" role="status"></span>
        <i *ngIf="!isLoading" class="bi bi-arrow-clockwise"></i> Recargar
      </button>
    </div>

    <div class="card-body masterserv-card-body d-flex flex-column">

      <ng-container *ngIf="(cotizaciones$ | async) as cotizaciones">

        <div *ngIf="isLoading" class="loading-container flex-grow-1 d-flex align-items-center justify-content-center">
          <div class="spinner-border masterserv-spinner" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>

        <div *ngIf="!isLoading">
          
          <div *ngIf="cotizaciones.length === 0" class="alert masterserv-alert-info text-center">
            <i class="bi bi-info-circle me-2"></i>
            No hay cotizaciones pendientes de revisión.
          </div>

          <div *ngIf="cotizaciones.length > 0" class="table-responsive flex-grow-1">
            <table class="table table-hover table-sm align-middle masterserv-table">
              <thead class="masterserv-table-header">
                <tr>
                  <th class="ps-3">ID</th>
                  <th>Proveedor</th>
                  <th>Items</th>
                  <th class="text-end">Total Ofertado</th>
                  <th>Entrega Estimada</th>
                  <th class="text-center">Recomendada</th> 
                  <th class="text-center pe-3">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let cot of cotizaciones" 
                    class="masterserv-table-row" 
                    [class.recomendada-row]="cot.esRecomendada"> 
                  
                  <td class="ps-3"><span class="badge masterserv-badge bg-dark">#{{ cot.id }}</span></td>
                  <td class="masterserv-name">{{ cot.proveedorNombre }}</td>
                  <td class="text-metal">{{ cot.items.length }} items</td>
                  <td class="masterserv-price text-end fw-bold">
                    {{ cot.precioTotalOfertado | currency:'ARS':'symbol':'1.2-2' }}
                  </td>
                  <td class="text-metal">{{ cot.fechaEntregaOfertada | date:'dd/MM/yyyy' }}</td>
                  
                  <td class="text-center">
                    
                    <div *ngIf="cot.esRecomendada">
                        <span class="badge bg-warning text-dark border border-dark shadow-sm">
                          <i class="bi bi-trophy-fill me-1"></i> MEJOR OPCIÓN
                        </span>
                    </div>

                    <div *ngIf="!cot.esRecomendada">
                        <span class="badge bg-dark border border-secondary text-light">
                          Competidora
                        </span>
                    </div>

                    <div class="mt-1">
                        <small [ngClass]="{
                            'text-danger fw-bold': cot.observacionAnalisis.includes('Incompleta'),
                            'text-success': cot.esRecomendada,
                            'text-white-50': !cot.esRecomendada && !cot.observacionAnalisis.includes('Incompleta')
                        }" style="font-size: 0.75rem;">
                            {{ cot.observacionAnalisis }}
                        </small>
                    </div>

                  </td>
                  
                  <td class="text-center pe-3">
                    <a [routerLink]="['/pos/cotizaciones', cot.id]" 
                       class="btn btn-sm"
                       [ngClass]="cot.esRecomendada ? 'btn-success fw-bold' : 'masterserv-btn-primary'">
                      {{ cot.esRecomendada ? 'Confirmar Ganadora' : 'Revisar' }}
                      <i class="bi bi-chevron-right ms-1"></i>
                    </a>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</div>