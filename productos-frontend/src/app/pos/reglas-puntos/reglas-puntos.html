<div class="reglas-container">

  <div *ngIf="isLoading" class="loading-container d-flex justify-content-center p-5 mt-5">
    <div class="spinner-border masterserv-spinner" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  
  <div *ngIf="errorMessage && !isLoading" class="alert masterserv-alert-danger">{{ errorMessage }}</div>

  <div class="row" *ngIf="!isLoading">

    <div class="col-lg-6" *appHasPermission="'ROLES_MANAGE'">
      <div class="card masterserv-card shadow-sm">
        <div class="card-header masterserv-card-header">
          <h5 class="masterserv-subtitle mb-0">Establecer Nueva Regla Activa</h5>
        </div>
        <div class="card-body masterserv-card-body">
          <form [formGroup]="reglaForm" (ngSubmit)="onSubmit()">
            
            <div class="row g-3">
              <p class="form-text text-metal col-12">
                Defina cuántos puntos (P) se ganan por cada (X) monto gastado (ARS), y cuál es el valor de canje de 1 Punto.
              </p>

              <div class="col-12">
                <label for="descripcion" class="form-label masterserv-label">Descripción de la Regla <span class="text-danger">*</span></label>
                <input type="text" id="descripcion" class="form-control masterserv-input"
                       placeholder="Ej: Promoción Día del Padre 2025"
                       formControlName="descripcion"
                       [ngClass]="{ 'is-invalid': reglaForm.get('descripcion')?.invalid && reglaForm.get('descripcion')?.touched }">
                <div *ngIf="reglaForm.get('descripcion')?.invalid && reglaForm.get('descripcion')?.touched" class="invalid-feedback d-block">
                  La descripción es obligatoria.
                </div>
              </div>
              <div class="col-sm-6">
                <label for="montoGasto" class="form-label masterserv-label">Por cada (ARS) <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text masterserv-input">$</span>
                  <input type="number" id="montoGasto" class="form-control masterserv-input"
                         formControlName="montoGasto" min="1" step="50"
                         [ngClass]="{ 'is-invalid': reglaForm.get('montoGasto')?.invalid && reglaForm.get('montoGasto')?.touched }">
                </div>
                 <div *ngIf="reglaForm.get('montoGasto')?.invalid && reglaForm.get('montoGasto')?.touched" class="invalid-feedback d-block">
                   El monto debe ser positivo.
                 </div>
              </div>

              <div class="col-sm-6">
                <label for="puntosGanados" class="form-label masterserv-label">Se ganan (Puntos) <span class="text-danger">*</span></label>
                 <div class="input-group">
                   <input type="number" id="puntosGanados" class="form-control masterserv-input"
                          formControlName="puntosGanados" min="1"
                          [ngClass]="{ 'is-invalid': reglaForm.get('puntosGanados')?.invalid && reglaForm.get('puntosGanados')?.touched }">
                   <span class="input-group-text masterserv-input"><i class="bi bi-star-fill"></i></span>
                 </div>
                 <div *ngIf="reglaForm.get('puntosGanados')?.invalid && reglaForm.get('puntosGanados')?.touched" class="invalid-feedback d-block">
                   Los puntos deben ser al menos 1.
                 </div>
              </div>

              <div class="col-sm-6">
                <label for="equivalenciaPuntos" class="form-label masterserv-label">1 Punto = (ARS) <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text masterserv-input">$</span>
                  <input type="number" id="equivalenciaPuntos" class="form-control masterserv-input"
                         formControlName="equivalenciaPuntos" min="0.01" step="0.1"
                         [ngClass]="{ 'is-invalid': reglaForm.get('equivalenciaPuntos')?.invalid && reglaForm.get('equivalenciaPuntos')?.touched }">
                </div>
                <div *ngIf="reglaForm.get('equivalenciaPuntos')?.invalid && reglaForm.get('equivalenciaPuntos')?.touched" class="invalid-feedback d-block">
                  La equivalencia debe ser positiva.
                </div>
              </div>
              
              <div class="col-sm-6">
                  <label for="caducidadPuntosMeses" class="form-label masterserv-label">Caducidad (Meses) <span class="text-danger">*</span></label>
                  <div class="input-group">
                     <input type="number" id="caducidadPuntosMeses" class="form-control masterserv-input"
                            formControlName="caducidadPuntosMeses" min="1"
                            [ngClass]="{ 'is-invalid': reglaForm.get('caducidadPuntosMeses')?.invalid && reglaForm.get('caducidadPuntosMeses')?.touched }">
                     <span class="input-group-text masterserv-input"><i class="bi bi-calendar-x"></i></span>
                  </div>
                  <div *ngIf="reglaForm.get('caducidadPuntosMeses')?.invalid && reglaForm.get('caducidadPuntosMeses')?.touched" class="invalid-feedback d-block">
                     La caducidad debe ser al menos 1 mes.
                  </div>
              </div>
            </div>

            <hr class="my-4 border-metal">
            <button type="submit" class="btn masterserv-btn-primary w-100" [disabled]="isSubmitting || reglaForm.invalid">
              <span *ngIf="!isSubmitting">Guardar y Activar Nueva Regla</span>
              <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              <span *ngIf="isSubmitting"> Guardando...</span>
            </button>
          </form>
        </div>
      </div>
    </div> 
    
    <div class="col-lg-6">
      <div class="card masterserv-card shadow-sm mb-3">
        <div class="card-header masterserv-card-header-success"> <h5 class="masterserv-subtitle mb-0">Regla Activa Actualmente</h5>
        </div>
        <div class="card-body masterserv-card-body">
          <div *ngIf="!reglaActiva" class="alert masterserv-alert-info text-center">
            No hay ninguna regla activa configurada.
          </div>
          <div *ngIf="reglaActiva">
            <h5 class="text-center masterserv-name mb-3">
              {{ reglaActiva.descripcion }}
            </h5>
            <h3 class="text-center text-success-light mb-3">
              {{ reglaActiva.puntosGanados }} Puntos
              <i class="bi bi-arrow-right-short"></i>
              {{ reglaActiva.montoGasto | currency:'ARS':'symbol':'1.0-0' }}
            </h3>
            
            <p class="text-center h5 mb-3 text-metal">
              (1 Punto = {{ reglaActiva.equivalenciaPuntos | currency:'ARS':'symbol':'1.2-2' }})
            </p>
            <p class="text-metal">
              <strong>Vigente desde:</strong> {{ reglaActiva.fechaInicioVigencia | date:'dd/MM/yyyy HH:mm' }}
              <br>
              <strong>Caducidad de puntos:</strong> {{ reglaActiva.caducidadPuntosMeses }} meses.
            </p>
          </div>
        </div>
      </div>

      <div class="card masterserv-card shadow-sm">
        <div class="card-header masterserv-card-header">
          <h5 class="masterserv-subtitle mb-0">Historial de Reglas (Caducadas)</h5>
        </div>
        <div class="card-body masterserv-card-body historial-body">
           <div *ngIf="!historialReglas || historialReglas.length === 0" class="text-center text-metal">
             No hay reglas anteriores.
           </div>
           <ul class="list-group list-group-flush" *ngIf="historialReglas.length > 0">
             <li *ngFor="let regla of historialReglas" class="list-group-item">
               <div class="d-flex justify-content-between align-items-center">
                 <div>
                   <strong class="d-block masterserv-name">{{ regla.descripcion }}</strong>
                   <span class="text-metal">{{ regla.puntosGanados }} pts = {{ regla.montoGasto | currency:'ARS':'symbol':'1.0-0' }}</span>
                   <span class="badge masterserv-badge bg-dark ms-2">{{ regla.estadoRegla }}</span>
                 </div>
                 <small class="text-metal">
                   {{ regla.fechaInicioVigencia | date:'dd/MM/yy' }}
                 </small>
               </div>
               <small class="text-info d-block">
                 (1 Pt = {{ regla.equivalenciaPuntos | currency:'ARS':'symbol':'1.2-2' }})
               </small>
             </li>
           </ul>
        </div>
      </div>

    </div> 
  </div> 
</div>