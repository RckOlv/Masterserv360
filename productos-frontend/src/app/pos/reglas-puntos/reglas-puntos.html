<div class="reglas-container">

  <div *ngIf="isLoading" class="loading-container d-flex justify-content-center p-5 mt-5">
    <div class="spinner-border masterserv-spinner" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>
  
  <div *ngIf="errorMessage && !isLoading" class="alert masterserv-alert-danger">{{ errorMessage }}</div>

  <div class="row" *ngIf="!isLoading">

    <div class="col-lg-6" *appHasPermission="'ROLES_MANAGE'">
      <div class="card masterserv-card shadow-sm mb-3">
        <div class="card-header masterserv-card-header">
          <h5 class="masterserv-subtitle mb-0">Configurar Regla de Puntos (Ganancia)</h5>
        </div>
        <div class="card-body masterserv-card-body">
          <form [formGroup]="reglaForm" (ngSubmit)="onSubmitRegla()">
            
            <div class="row g-3">
              <div class="col-12">
                <label for="descripcion" class="form-label masterserv-label">Descripción de la Regla <span class="text-danger">*</span></label>
                <input type="text" id="descripcion" class="form-control masterserv-input"
                       placeholder="Ej: Promoción Día del Padre 2025"
                       formControlName="descripcion"
                       [ngClass]="{ 'is-invalid': fRegla['descripcion'].invalid && fRegla['descripcion'].touched }">
                <div *ngIf="fRegla['descripcion'].invalid && fRegla['descripcion'].touched" class="invalid-feedback d-block">
                  La descripción es obligatoria.
                </div>
              </div>
              <div class="col-sm-6">
                <label for="montoGasto" class="form-label masterserv-label">Por cada (ARS) <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text masterserv-input">$</span>
                  <input type="number" id="montoGasto" class="form-control masterserv-input"
                         formControlName="montoGasto" min="1" step="50"
                         [ngClass]="{ 'is-invalid': fRegla['montoGasto'].invalid && fRegla['montoGasto'].touched }">
                </div>
                 <div *ngIf="fRegla['montoGasto'].invalid && fRegla['montoGasto'].touched" class="invalid-feedback d-block">
                   El monto debe ser positivo.
                 </div>
              </div>

              <div class="col-sm-6">
                <label for="puntosGanados" class="form-label masterserv-label">Se ganan (Puntos) <span class="text-danger">*</span></label>
                 <div class="input-group">
                   <input type="number" id="puntosGanados" class="form-control masterserv-input"
                          formControlName="puntosGanados" min="1"
                          [ngClass]="{ 'is-invalid': fRegla['puntosGanados'].invalid && fRegla['puntosGanados'].touched }">
                   <span class="input-group-text masterserv-input"><i class="bi bi-star-fill"></i></span>
                 </div>
                 <div *ngIf="fRegla['puntosGanados'].invalid && fRegla['puntosGanados'].touched" class="invalid-feedback d-block">
                   Los puntos deben ser al menos 1.
                 </div>
              </div>
              
              <div class="col-sm-6">
                  <label for="caducidadPuntosMeses" class="form-label masterserv-label">Caducidad (Meses) <span class="text-danger">*</span></label>
                  <div class="input-group">
                     <input type="number" id="caducidadPuntosMeses" class="form-control masterserv-input"
                            formControlName="caducidadPuntosMeses" min="1"
                            [ngClass]="{ 'is-invalid': fRegla['caducidadPuntosMeses'].invalid && fRegla['caducidadPuntosMeses'].touched }">
                     <span class="input-group-text masterserv-input"><i class="bi bi-calendar-x"></i></span>
                  </div>
                  <div *ngIf="fRegla['caducidadPuntosMeses'].invalid && fRegla['caducidadPuntosMeses'].touched" class="invalid-feedback d-block">
                      La caducidad debe ser al menos 1 mes.
                  </div>
              </div>

               <div class="col-sm-6">
                <label for="equivalenciaPuntos" class="form-label masterserv-label">1 Punto = (ARS) (Informativo)</label>
                <div class="input-group">
                  <span class="input-group-text masterserv-input">$</span>
                  <input type="number" id="equivalenciaPuntos" class="form-control masterserv-input"
                         formControlName="equivalenciaPuntos" min="0.01" step="0.1">
                </div>
              </div>
            </div>

            <hr class="my-4 border-metal">
            <button type="submit" class="btn masterserv-btn-primary w-100" [disabled]="isSubmitting || reglaForm.invalid">
              <span *ngIf="!isSubmitting">Guardar y Activar Nueva Regla</span>
              <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              <span *ngIf="isSubmitting"> Guardando...</span>
            </button>
          </form>
        </div>
      </div>
    </div> 
    
    <div class="col-lg-6">
      
      <div class="card masterserv-card shadow-sm mb-3">
        <div class="card-header masterserv-card-header-success">
          <h5 class="masterserv-subtitle mb-0">Regla Activa Actualmente</h5>
        </div>
        <div class="card-body masterserv-card-body">
          <div *ngIf="!reglaActiva" class="alert masterserv-alert-info text-center">
            No hay ninguna regla activa configurada.
          </div>
          
          <div *ngIf="reglaActiva as regla">
            <h5 class="text-center masterserv-name mb-3">
              {{ regla.descripcion }}
            </h5>
            <h3 class="text-center text-success-light mb-3">
              {{ regla.puntosGanados }} Puntos
              <i class="bi bi-arrow-right-short"></i>
              {{ regla.montoGasto | currency:'ARS':'symbol':'1.0-0' }}
            </h3>
            
            <p class="text-center h5 mb-3 text-metal" *ngIf="regla.equivalenciaPuntos">
              (1 Punto = {{ regla.equivalenciaPuntos | currency:'ARS':'symbol':'1.2-2' }})
            </p>
            <p class="text-metal">
              <strong>Vigente desde:</strong> {{ regla.fechaInicioVigencia | date:'dd/MM/yyyy HH:mm' }}
              <br>
              <strong>Caducidad de puntos:</strong> {{ regla.caducidadPuntosMeses }} meses.
            </p>
          </div>
        </div>
      </div>

      <div class="card masterserv-card shadow-sm mb-3" *appHasPermission="'ROLES_MANAGE'">
        <div class="card-header masterserv-card-header-success d-flex justify-content-between align-items-center">
          <h5 class="masterserv-subtitle mb-0">Recompensas de Canje</h5>
          <button class="btn btn-sm btn-outline-light" (click)="abrirModalNuevaRecompensa()" [disabled]="!reglaActiva">
            <i class="bi bi-plus-lg"></i> Nueva Recompensa
          </button>
        </div>
        <div class="card-body masterserv-card-body">
          <div *ngIf="!reglaActiva" class="alert masterserv-alert-info text-center">
            Crea una Regla de Puntos a la izquierda para poder añadir recompensas.
          </div>
          
          <div *ngIf="reglaActiva as regla">
          
            <ul class="list-group list-group-flush" *ngIf="regla.recompensas && regla.recompensas.length > 0">
              <li *ngFor="let rec of regla.recompensas" class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong class="d-block masterserv-name">{{ rec.descripcion }}</strong>
                    
                    <span class="text-metal small">
                      Stock: <span [ngClass]="rec.stock > 0 ? 'text-success' : 'text-danger'">{{ rec.stock }}</span> |
                      Costo: {{ rec.puntosRequeridos }} Pts.
                    </span>

                    <span class="badge masterserv-badge bg-dark ms-2">
                      {{ rec.tipoDescuento === tipoDescuentoEnum.FIJO ? (rec.valor | currency:'ARS') : (rec.valor + '% OFF') }}
                    </span>
                    <span *ngIf="rec.categoriaNombre" class="badge masterserv-badge masterserv-badge-warning ms-1">
                      {{ rec.categoriaNombre }}
                    </span>
                    <span *ngIf="!rec.categoriaNombre && rec.tipoDescuento === tipoDescuentoEnum.PORCENTAJE" class="badge bg-secondary ms-1">
                      Todo
                    </span>
                  </div>
                  <div class="btn-group btn-group-sm">
                    <button class="btn masterserv-btn-outline-primary" (click)="abrirModalEditarRecompensa(rec)">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn masterserv-btn-outline-danger" (click)="eliminarRecompensa(rec.id!)">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
              </li>
            </ul>
            
            <div *ngIf="!regla.recompensas || regla.recompensas.length === 0" class="text-center text-metal">
              No hay recompensas creadas para esta regla.
            </div>
          </div>
        </div>
      </div>

      <div class="card masterserv-card shadow-sm">
        <div class="card-header masterserv-card-header">
          <h5 class="masterserv-subtitle mb-0">Historial de Reglas (Caducadas)</h5>
        </div>
        <div class="card-body masterserv-card-body historial-body">
           <div *ngIf="!historialReglas || historialReglas.length === 0" class="text-center text-metal">
             No hay reglas anteriores.
           </div>
           <ul class="list-group list-group-flush" *ngIf="historialReglas.length > 0">
             <li *ngFor="let regla of historialReglas" class="list-group-item">
               <div class="d-flex justify-content-between align-items-center">
                 <div>
                   <strong class="d-block masterserv-name">{{ regla.descripcion }}</strong>
                   <span class="text-metal">{{ regla.puntosGanados }} pts = {{ regla.montoGasto | currency:'ARS':'symbol':'1.0-0' }}</span>
                   <span class="badge masterserv-badge bg-dark ms-2">{{ regla.estadoRegla }}</span>
                 </div>
                 <small class="text-metal">
                   {{ regla.fechaInicioVigencia | date:'dd/MM/yy' }}
                 </small>
               </div>
               <small class="text-info d-block" *ngIf="regla.equivalenciaPuntos">
                 (1 Pt = {{ regla.equivalenciaPuntos | currency:'ARS':'symbol':'1.2-2' }})
               </small>
             </li>
           </ul>
        </div>
      </div>

    </div> 
  </div> 
</div>

<div class="modal fade" id="recompensaModal" tabindex="-1" aria-labelledby="recompensaModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="recompensaModalLabel">{{ esEdicionRecompensa ? 'Editar' : 'Nueva' }} Recompensa</h5>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModalRecompensa()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        
        <div *ngIf="modalErrorMessage" class="alert masterserv-alert-danger">
          {{ modalErrorMessage }}
        </div>
        
        <form [formGroup]="recompensaForm" id="ngRecompensaForm" (ngSubmit)="guardarRecompensa()">
          
          <div class="mb-3">
            <label for="recDescripcion" class="form-label masterserv-label">Descripción <span class="text-danger">*</span></label>
            <input type="text" id="recDescripcion" class="form-control masterserv-input" 
                   formControlName="descripcion" placeholder="Ej: 20% OFF en Neumáticos"
                   [ngClass]="{ 'is-invalid': fRec['descripcion'].invalid && fRec['descripcion'].touched }">
            <div *ngIf="fRec['descripcion'].invalid && fRec['descripcion'].touched" class="invalid-feedback">
              Obligatorio.
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="recPuntos" class="form-label masterserv-label">Costo (Puntos) <span class="text-danger">*</span></label>
              <input type="number" id="recPuntos" class="form-control masterserv-input" 
                     formControlName="puntosRequeridos"
                     [ngClass]="{ 'is-invalid': fRec['puntosRequeridos'].invalid && fRec['puntosRequeridos'].touched }">
              <div *ngIf="fRec['puntosRequeridos'].invalid && fRec['puntosRequeridos'].touched" class="invalid-feedback">
                <div *ngIf="fRec['puntosRequeridos'].errors?.['required']">Obligatorio.</div>
                <div *ngIf="fRec['puntosRequeridos'].errors?.['min']">Debe ser > 0.</div>
              </div>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="recStock" class="form-label masterserv-label">Stock <span class="text-danger">*</span></label>
              <input type="number" id="recStock" class="form-control masterserv-input" 
                     formControlName="stock"
                     placeholder="Ej: 50"
                     [ngClass]="{ 'is-invalid': fRec['stock'].invalid && fRec['stock'].touched }">
              <div *ngIf="fRec['stock'].invalid && fRec['stock'].touched" class="invalid-feedback">
                Requerido (>= 0).
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="recTipo" class="form-label masterserv-label">Tipo Descuento <span class="text-danger">*</span></label>
              <select id="recTipo" class="form-select masterserv-input" formControlName="tipoDescuento">
                <option [ngValue]="tipoDescuentoEnum.FIJO">Monto Fijo (ARS)</option>
                <option [ngValue]="tipoDescuentoEnum.PORCENTAJE">Porcentaje (%)</option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="recValor" class="form-label masterserv-label">Valor <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text masterserv-input">
                  {{ fRec['tipoDescuento'].value === tipoDescuentoEnum.FIJO ? '$' : '%' }}
                </span>
                <input type="number" id="recValor" class="form-control masterserv-input" 
                       formControlName="valor"
                       [ngClass]="{ 'is-invalid': fRec['valor'].invalid && fRec['valor'].touched }">
              </div>
              <div *ngIf="fRec['valor'].invalid && fRec['valor'].touched" class="invalid-feedback d-block">
                 <div *ngIf="fRec['valor'].errors?.['required']">Obligatorio.</div>
                 <div *ngIf="fRec['valor'].errors?.['min']">Debe ser > 0.</div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label masterserv-label d-block">Aplicar descuento a:</label>

            <div *ngIf="fRec['tipoDescuento'].value === tipoDescuentoEnum.FIJO">
              <span class="badge bg-secondary w-100 py-2">
                <i class="bi bi-cart-check"></i> Toda la compra
              </span>
              <small class="text-metal mt-1 d-block">
                (Monto fijo siempre aplica al total)
              </small>
            </div>

            <div *ngIf="fRec['tipoDescuento'].value === tipoDescuentoEnum.PORCENTAJE">
              
              <div class="btn-group w-100 mb-2" role="group">
                <input type="radio" class="btn-check" name="aplicarARadio" id="radioTodo" 
                       [checked]="aplicarA === 'TODO'" 
                       (change)="aplicarA = 'TODO'; fRec['categoriaId'].setValue(null)">
                <label class="btn btn-outline-light" for="radioTodo">Todo</label>
              
                <input type="radio" class="btn-check" name="aplicarARadio" id="radioCat" 
                       [checked]="aplicarA === 'CATEGORIA'" 
                       (change)="aplicarA = 'CATEGORIA'">
                <label class="btn btn-outline-light" for="radioCat">Categoría</label>
              </div>

              <div *ngIf="aplicarA === 'CATEGORIA'">
                <select id="recCategoria" class="form-select masterserv-input" 
                        formControlName="categoriaId">
                  <option [ngValue]="null">Seleccione...</option>
                  <option *ngFor="let cat of categorias" [ngValue]="cat.id">{{ cat.nombre }}</option>
                </select>
                
                <div *ngIf="aplicarA === 'CATEGORIA' && !fRec['categoriaId'].value" class="text-warning small mt-1">
                  <i class="bi bi-exclamation-circle"></i> Seleccione una categoría.
                </div>
              </div>

            </div>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn masterserv-btn-secondary" (click)="cerrarModalRecompensa()" [disabled]="isSubmittingRecompensa">Cancelar</button>
        <button type="submit" form="ngRecompensaForm" class="btn masterserv-btn-primary" 
                [disabled]="recompensaForm.invalid || isSubmittingRecompensa || (aplicarA === 'CATEGORIA' && !fRec['categoriaId'].value)">
          <span *ngIf="!isSubmittingRecompensa">{{ esEdicionRecompensa ? 'Actualizar' : 'Crear' }} Recompensa</span>
          <span *ngIf="isSubmittingRecompensa" class="spinner-border spinner-border-sm" role="status"></span>
        </button>
      </div>
    </div>
  </div>
</div>