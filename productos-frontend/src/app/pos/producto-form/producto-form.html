<div class="productos-form-container" *appHasPermission="'PRODUCTOS_MANAGE'">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-10 col-xl-9">
        
        <div class="card masterserv-card">
          
          <div class="card-header masterserv-card-header">
            <h4 class="masterserv-title mb-0">
              <i class="bi bi-box-seam me-2"></i>{{ pageTitle }}
            </h4>
          </div>
          
          <div class="card-body masterserv-card-body p-4">

            <div *ngIf="isLoading && esEdicion" class="loading-container my-3 text-center">
              <div class="spinner-border masterserv-spinner" role="status">
                <span class="visually-hidden">Cargando datos...</span>
              </div>
            </div>

            <div *ngIf="errorMessage && !isLoading" class="alert masterserv-alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>{{ errorMessage }}
            </div>

            <form *ngIf="!isLoading || !esEdicion" [formGroup]="productoForm" (ngSubmit)="onSubmit()">

              <div class="row mb-4">
                
                <div class="col-md-8">
                  <div class="row mb-3">
                    <div class="col-md-4">
                      <label for="codigo" class="form-label masterserv-label">Código <span class="text-danger">*</span></label>
                      <div class="input-group">
                        <span class="input-group-text masterserv-input"><i class="bi bi-magic"></i></span>
                        <input type="text" id="codigo" class="form-control masterserv-input" formControlName="codigo"
                               readonly placeholder="Auto..."
                               [ngClass]="{ 'is-invalid': f['codigo'].invalid && f['codigo'].touched }">
                      </div>
                      <div class="invalid-feedback d-block" *ngIf="f['codigo'].invalid && f['codigo'].touched">
                         Requerido (Se genera auto).
                      </div>
                    </div>
                    <div class="col-md-8 mt-3 mt-md-0">
                      <label for="nombre" class="form-label masterserv-label">Nombre <span class="text-danger">*</span></label>
                      <input type="text" id="nombre" class="form-control masterserv-input" formControlName="nombre"
                             placeholder="Ej: Batería 12V Gel"
                             [ngClass]="{ 'is-invalid': f['nombre'].invalid && f['nombre'].touched }">
                      <div class="invalid-feedback" *ngIf="f['nombre'].errors?.['required'] && f['nombre'].touched">El nombre es obligatorio.</div>
                      <div class="invalid-feedback" *ngIf="f['nombre'].errors?.['minlength'] && f['nombre'].touched">Mínimo 3 letras.</div>
                    </div>
                  </div>

                  <div class="mb-3 mb-md-0"> 
                    <label for="descripcion" class="form-label masterserv-label">Descripción</label>
                    <textarea id="descripcion" class="form-control masterserv-input" formControlName="descripcion" rows="4"></textarea>
                  </div>
                </div>

                <div class="col-md-4 d-flex flex-column align-items-center justify-content-center border-start border-secondary pt-4 pt-md-0 mt-3 mt-md-0">
                  <label class="form-label masterserv-label text-center w-100 mb-3">Imagen del Producto</label>
                  
                  <div class="position-relative d-flex align-items-center justify-content-center bg-dark mb-3" 
                       style="width: 140px; height: 140px; border-radius: 8px; overflow: hidden; border: 1px dashed #666; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    <img *ngIf="previewUrl" [src]="previewUrl" alt="Vista previa" style="width: 100%; height: 100%; object-fit: cover;">
                    <i *ngIf="!previewUrl" class="bi bi-camera text-secondary" style="font-size: 4rem; opacity: 0.5;"></i>
                  </div>
                  
                  <div class="d-flex gap-2">
                    <input type="file" id="imagenFile" class="d-none" accept="image/*" (change)="onFileSelected($event)">
                    
                    <label for="imagenFile" class="btn btn-sm btn-outline-warning m-0" style="cursor: pointer;">
                      <i class="bi bi-upload me-1"></i> {{ previewUrl ? 'Cambiar Foto' : 'Subir Foto' }}
                    </label>
                    
                    <button *ngIf="previewUrl" type="button" class="btn btn-sm btn-outline-danger" (click)="removerImagen()" title="Quitar imagen">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                  <div class="text-secondary text-center mt-2" style="font-size: 0.75rem;">JPG, PNG, WEBP (Máx 2MB)</div>
                </div>

              </div>

              <hr class="border-secondary mb-4 opacity-25">

              <div class="row mb-3">
                <div class="col-md-6" *ngIf="esEdicion">
                  <label for="precioCosto" class="form-label masterserv-label text-secondary">Precio Costo <small>(Auto)</small></label>
                    <div class="input-group">
                      <span class="input-group-text masterserv-input bg-dark text-secondary">$</span>
                      <input type="number" id="precioCosto" class="form-control masterserv-input bg-dark text-secondary" formControlName="precioCosto" readonly
                             [ngClass]="{ 'is-invalid': f['precioCosto'].invalid && f['precioCosto'].touched }"
                             title="El costo se actualiza al ingresar pedidos">
                  </div>
                </div>

                <div [ngClass]="esEdicion ? 'col-md-6' : 'col-md-12'">
                  <label for="precioVenta" class="form-label masterserv-label">Precio Venta Público <span class="text-danger">*</span></label>
                  <div class="input-group">
                    <span class="input-group-text masterserv-input text-success fw-bold">$</span>
                    <input type="number" id="precioVenta" class="form-control masterserv-input" formControlName="precioVenta" min="0" step="0.01"
                           [ngClass]="{ 'is-invalid': f['precioVenta'].invalid && f['precioVenta'].touched }">
                  </div>
                    <div class="invalid-feedback d-block" *ngIf="f['precioVenta'].invalid && f['precioVenta'].touched">
                        Requerido (Mínimo 0).
                    </div>
                </div>
              </div>

              <div *ngIf="productoForm.errors?.['ventaMenorCosto'] && (f['precioVenta'].touched || f['precioCosto'].touched)" 
                   class="alert alert-warning py-2 small d-flex align-items-center">
                  <i class="bi bi-exclamation-triangle-fill me-2"></i>
                  <div>
                      <strong>Advertencia:</strong> El precio de venta es menor al costo. ¿Estás seguro?
                  </div>
              </div>
              
              <div class="row mb-3">
                 <div class="col-md-6">
                   <label for="stockMinimo" class="form-label masterserv-label">Stock Mínimo <span class="text-danger">*</span></label>
                   <input type="number" id="stockMinimo" class="form-control masterserv-input" formControlName="stockMinimo" min="0" step="1"
                          [ngClass]="{ 'is-invalid': f['stockMinimo'].invalid && f['stockMinimo'].touched }">
                    <div class="invalid-feedback" *ngIf="f['stockMinimo'].invalid && f['stockMinimo'].touched">Requerido (Mín 0).</div>
                 </div>
                 
                 <div class="col-md-6 mt-3 mt-md-0">
                   <label for="loteReposicion" class="form-label masterserv-label">Lote de Reposición <span class="text-danger">*</span></label>
                   <input type="number" id="loteReposicion" class="form-control masterserv-input" formControlName="loteReposicion" min="1" step="1"
                          [ngClass]="{ 'is-invalid': f['loteReposicion'].invalid && f['loteReposicion'].touched }">
                    <div class="invalid-feedback" *ngIf="f['loteReposicion'].invalid && f['loteReposicion'].touched">Requerido (Mín 1).</div>
                 </div>
              </div>
              
              <div class="row mb-4">
                 <div class="col-md-6">
                   <label for="categoriaId" class="form-label masterserv-label">Categoría <span class="text-danger">*</span></label>
                   
                   <div class="d-flex gap-2">
                       <ng-select 
                           [items]="categorias" 
                           bindLabel="nombre" 
                           bindValue="id" 
                           placeholder="Buscar categoría..."
                           formControlName="categoriaId"
                           class="masterserv-select-dark flex-grow-1 custom-ng-select"
                           [clearable]="false"
                           [ngClass]="{ 'is-invalid': f['categoriaId'].invalid && f['categoriaId'].touched }">
                       </ng-select>
                       
                       <button type="button" class="btn btn-outline-success" (click)="abrirModalCategoria()" title="Nueva Categoría">
                           <i class="bi bi-plus-lg"></i>
                       </button>
                   </div>
                   <div class="text-danger small mt-1" *ngIf="f['categoriaId'].invalid && f['categoriaId'].touched">
                     La categoría es obligatoria.
                   </div>
                 </div>

                 <div class="col-md-6 mt-3 mt-md-0">
                   <label for="estado" class="form-label masterserv-label">Estado <span class="text-danger">*</span></label>
                    <select id="estado" class="form-select masterserv-input" formControlName="estado"
                            [ngClass]="{ 'is-invalid': f['estado'].invalid && f['estado'].touched }">
                      <option value="ACTIVO">Activo</option>
                      <option value="INACTIVO">Inactivo</option>
                    </select>
                 </div>
              </div>

              <div class="d-flex justify-content-end pt-3 border-top border-secondary">
                <button type="button" class="btn masterserv-btn-secondary me-2" [routerLink]="['/pos/productos']">
                  <i class="bi bi-arrow-left me-1"></i>Cancelar
                </button>
                <button type="submit" class="btn btn-warning fw-bold text-dark px-4" [disabled]="productoForm.invalid || isLoading">
                  <span *ngIf="!isLoading">
                    <i class="bi" [class.bi-check-lg]="!esEdicion" [class.bi-arrow-repeat]="esEdicion"></i>
                    {{ esEdicion ? 'Actualizar Producto' : 'Crear Producto' }}
                  </span>
                  <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </button>
              </div>

            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop fade show" *ngIf="mostrarModalCategoria" style="z-index: 1060;"></div>
<div class="modal fade show d-block" tabindex="-1" *ngIf="mostrarModalCategoria" style="z-index: 1070;">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content" style="background-color: #2c2c2c; border: 1px solid #28a745; color: white;">
            <div class="modal-header border-secondary py-2">
                <h6 class="modal-title text-success"><i class="bi bi-tags-fill me-2"></i>Nueva Categoría</h6>
                <button type="button" class="btn-close btn-close-white" (click)="cerrarModalCategoria()"></button>
            </div>
            <div class="modal-body">
                <form [formGroup]="categoriaForm">
                    <div class="mb-2">
                        <label class="small text-white-50">Nombre *</label>
                        <input type="text" class="form-control form-control-sm masterserv-input" formControlName="nombre">
                    </div>
                    <div class="mb-2">
                        <label class="small text-white-50">Descripción</label>
                        <textarea class="form-control form-control-sm masterserv-input" rows="2" formControlName="descripcion"></textarea>
                    </div>
                    <div class="d-grid mt-3">
                        <button type="button" class="btn btn-sm btn-success" 
                                (click)="guardarNuevaCategoria()" 
                                [disabled]="categoriaForm.invalid || isSavingCategoria">
                            <span *ngIf="isSavingCategoria" class="spinner-border spinner-border-sm me-1"></span>
                            Crear y Seleccionar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>