<div class="pedidos-container">

  <div class="card masterserv-card">
    
    <div class="card-header masterserv-card-header d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
          <h4 class="masterserv-title mb-0">
            <i class="bi bi-clipboard-data me-2"></i>Gestión de Pedidos
          </h4>
          <button class="btn btn-sm btn-outline-warning" (click)="toggleFiltros()">
            <i class="bi" [ngClass]="mostrarFiltros ? 'bi-funnel-fill' : 'bi-funnel'"></i> 
            {{ mostrarFiltros ? 'Ocultar Filtros' : 'Filtrar' }}
          </button>
      </div>

      <button *appHasPermission="'PEDIDOS_MANAGE'" class="btn masterserv-btn-success btn-sm" [routerLink]="['/pos/pedidos/nuevo']">
        <i class="bi bi-plus-lg"></i> Nuevo Pedido
      </button>
    </div>

    <div class="card-body bg-dark border-bottom border-secondary" *ngIf="mostrarFiltros">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="text-white-50 small mb-1">Proveedor</label>
                <select class="form-select form-select-sm bg-dark text-white border-secondary" [(ngModel)]="filtro.proveedorId">
                    <option [ngValue]="null">Todos</option>
                    <option *ngFor="let prov of proveedores" [ngValue]="prov.id">
                        {{ prov.razonSocial }}
                    </option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="text-white-50 small mb-1">Estado</label>
                <select class="form-select form-select-sm bg-dark text-white border-secondary" [(ngModel)]="filtro.estado">
                    <option [ngValue]="null">Todos</option>
                    <option value="PENDIENTE">Pendiente</option>
                    <option value="EN_CAMINO">En Camino</option>
                    <option value="COMPLETADO">Completado</option>
                    <option value="CANCELADO">Cancelado</option>
                </select>
            </div>

            <div class="col-md-5">
                <label class="text-white-50 small mb-1">Rango de Fechas</label>
                <div class="input-group input-group-sm">
                    <input type="date" class="form-control bg-dark text-white border-secondary" [(ngModel)]="filtro.fechaDesde">
                    <span class="input-group-text bg-secondary text-white border-secondary">hasta</span>
                    <input type="date" class="form-control bg-dark text-white border-secondary" [(ngModel)]="filtro.fechaHasta">
                </div>
            </div>

            <div class="col-md-2 d-flex align-items-end gap-2">
                <button class="btn btn-sm btn-info w-100" (click)="buscar()">
                    <i class="bi bi-search"></i> Buscar
                </button>
                <button class="btn btn-sm btn-outline-secondary w-50" (click)="limpiarFiltros()" title="Limpiar">
                    <i class="bi bi-eraser"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="card-body masterserv-card-body d-flex flex-column">
      
      <div class="content-main flex-grow-1 d-flex flex-column">
        
        <div *ngIf="isLoading" class="loading-container flex-grow-1 d-flex align-items-center justify-content-center">
          <div class="spinner-border masterserv-spinner" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>

        <div *ngIf="errorMessage && !isLoading" class="alert masterserv-alert-danger mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>{{ errorMessage }}
        </div>

        <div *ngIf="!isLoading && pedidosPage && pedidosPage.content.length > 0" class="table-responsive flex-grow-1">
          <table class="table table-hover table-sm align-middle masterserv-table">
            <thead class="masterserv-table-header">
              <tr>
                <th class="ps-3">ID Pedido</th>
                <th>Proveedor</th>
                <th>Fecha</th>
                <th>Resumen Items</th>
                <th class="text-end">Total</th>
                <th class="text-center">Estado</th>
                <th *appHasPermission="'PEDIDOS_MANAGE'" class="text-center pe-3">Acciones</th>
                </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of pedidosPage.content" class="masterserv-table-row">
                <td class="ps-3">#{{ p.id }}</td>
                <td class="masterserv-name">{{ p.proveedorRazonSocial || 'N/A' }}</td>
                <td>{{ p.fechaPedido | date:'dd/MM/yyyy HH:mm' }}</td>
                
                <td class="text-muted small" style="max-width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <span *ngFor="let d of p.detalles | slice:0:2; let isLast = last">
                        {{ d.productoNombre }} <span class="text-secondary">(x{{ d.cantidad }})</span>{{ !isLast ? ', ' : '' }}
                    </span>
                    <span *ngIf="p.detalles.length > 2" class="badge bg-secondary ms-1" style="font-size: 0.7rem;">
                        +{{ p.detalles.length - 2 }} más
                    </span>
                </td>

                <td class="masterserv-price text-end">{{ p.totalPedido | currency:'ARS':'symbol':'1.2-2' }}</td>
                <td class="text-center">
                  <span class="badge masterserv-badge" 
                        [ngClass]="{
                          'masterserv-badge-warning': p.estado === 'PENDIENTE', 
                          'masterserv-badge-info': p.estado === 'EN_CAMINO', 
                          'masterserv-badge-success': p.estado === 'COMPLETADO', 
                          'masterserv-badge-danger': p.estado === 'CANCELADO'
                        }">
                    {{ p.estado === 'EN_CAMINO' ? 'EN CAMINO' : p.estado }}
                  </span>
                </td>
                <td *appHasPermission="'PEDIDOS_MANAGE'" class="text-center pe-3">
                  
                  <button class="btn masterserv-btn-outline-success btn-sm me-1" 
                          (click)="verDetalles(p.id)" 
                          title="Ver Comprobante">
                    <i class="bi bi-eye"></i>
                  </button>

                  <ng-container *ngIf="p.estado === 'PENDIENTE' || p.estado === 'EN_CAMINO'">
                    
                    <button class="btn btn-action-success btn-sm me-1" 
                            (click)="marcarCompletado(p.id)" 
                            title="Marcar como Completado (Ingresar Stock)">
                      <i class="bi bi-check-lg"></i>
                    </button>
                    
                    <button *ngIf="p.estado === 'PENDIENTE'" 
                            class="btn masterserv-btn-outline-danger btn-sm" 
                            (click)="marcarCancelado(p.id)" 
                            title="Cancelar Pedido">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </ng-container>
                </td>
                </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="!isLoading && pedidosPage && pedidosPage.content.length === 0" class="empty-container flex-grow-1 d-flex align-items-center justify-content-center">
          <div class="alert masterserv-alert-info text-center">
            <i class="bi bi-info-circle me-2"></i>
            No se encontraron pedidos con esos criterios.
          </div>
        </div>

        <div *ngIf="!isLoading && pedidosPage && pedidosPage.totalPages > 1" class="masterserv-pagination">
          <div class="pagination-info">
             Página {{ pedidosPage.number + 1 }} de {{ totalPaginas }}
          </div>
          
          <ul class="pagination pagination-sm justify-content-center">
            <li class="page-item" [class.disabled]="pedidosPage.number === 0">
              <a class="page-link masterserv-page-link" href="javascript:void(0)" (click)="irAPagina(pedidosPage.number - 1)">&laquo;</a>
            </li>
            <li class="page-item active">
               <span class="page-link masterserv-page-link">{{ pedidosPage.number + 1 }}</span>
            </li>
            <li class="page-item" [class.disabled]="pedidosPage.number + 1 >= totalPaginas">
              <a class="page-link masterserv-page-link" href="javascript:void(0)" (click)="irAPagina(pedidosPage.number + 1)">&raquo;</a>
            </li>
          </ul>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop fade show" *ngIf="pedidoSeleccionado"></div>
<div class="modal fade show" tabindex="-1" role="dialog" style="display: block;" *ngIf="pedidoSeleccionado">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content masterserv-card" style="border: 1px solid #E41E26;">
      
      <div class="card-header masterserv-card-header d-flex justify-content-between align-items-center">
        <h5 class="masterserv-title mb-0" style="font-size: 1.2rem;">
          <i class="bi bi-receipt me-2"></i>Comprobante Pedido #{{ pedidoSeleccionado.id }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModal()"></button>
      </div>

      <div class="modal-body masterserv-card-body">
        
        <div class="row mb-4 border-bottom border-secondary pb-3">
          <div class="col-md-6 border-end border-secondary">
            <h6 class="text-danger text-uppercase fw-bold mb-3 small">Datos del Proveedor</h6>
            <p class="mb-1 fw-bold text-white fs-5">{{ pedidoSeleccionado.proveedorRazonSocial }}</p>
            <p class="mb-1 text-dim small">
                <i class="bi bi-person-vcard me-2"></i>CUIT: <span class="text-white">{{ pedidoSeleccionado.proveedorCuit }}</span>
            </p>
            <p class="mb-1 text-dim small">
                <i class="bi bi-envelope me-2"></i>{{ pedidoSeleccionado.proveedorEmail || 'Sin email' }}
            </p>
            <p class="mb-0 text-dim small" *ngIf="pedidoSeleccionado.proveedorTelefono">
                <i class="bi bi-telephone me-2"></i>{{ pedidoSeleccionado.proveedorTelefono }}
            </p>
          </div>

          <div class="col-md-6 ps-4">
            <h6 class="text-danger text-uppercase fw-bold mb-3 small">Información del Pedido</h6>
            <div class="d-flex justify-content-between mb-2">
                <span class="text-dim small">Estado:</span>
                <span class="badge masterserv-badge"
                    [ngClass]="{
                      'masterserv-badge-warning': pedidoSeleccionado.estado === 'PENDIENTE', 
                      'masterserv-badge-info': pedidoSeleccionado.estado === 'EN_CAMINO', 
                      'masterserv-badge-success': pedidoSeleccionado.estado === 'COMPLETADO', 
                      'masterserv-badge-danger': pedidoSeleccionado.estado === 'CANCELADO'
                    }">
                {{ pedidoSeleccionado.estado === 'EN_CAMINO' ? 'EN CAMINO' : pedidoSeleccionado.estado }}
              </span>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span class="text-dim small">Fecha Emisión:</span>
                <span class="text-white small">{{ pedidoSeleccionado.fechaPedido | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>
            <div class="d-flex justify-content-between">
                <span class="text-dim small">Solicitado por:</span>
                <span class="text-white small fw-bold">{{ pedidoSeleccionado.usuarioSolicitante }}</span>
            </div>
          </div>
        </div>

        <h6 class="text-danger text-uppercase fw-bold mb-3 small">Detalle de Productos</h6>
        <div class="table-responsive mb-3" style="background: rgba(0,0,0,0.2); border-radius: 6px;">
          <table class="table table-dark table-sm table-borderless align-middle mb-0">
            <thead class="text-secondary" style="border-bottom: 1px solid #333;">
              <tr>
                <th class="ps-3">Cód.</th>
                <th>Producto</th>
                <th class="text-center">Cant.</th>
                <th class="text-end">Precio Unit.</th>
                <th class="text-end pe-3">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of pedidoSeleccionado.detalles">
                <td class="ps-3 text-dim small font-monospace">{{ item.productoCodigo }}</td>
                <td class="text-white">{{ item.productoNombre }}</td>
                <td class="text-center fw-bold text-white">{{ item.cantidad }}</td>
                <td class="text-end text-dim font-monospace">{{ item.precioUnitario | currency:'ARS':'symbol':'1.2-2' }}</td>
                <td class="text-end pe-3 fw-bold text-warning font-monospace">{{ item.subtotal | currency:'ARS':'symbol':'1.2-2' }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="row mt-3">
          <div class="col-12 text-end">
            <span class="text-dim me-3 text-uppercase small">Total</span>
            <h3 class="text-warning d-inline-block m-0 font-monospace">
              {{ pedidoSeleccionado.totalPedido | currency:'ARS':'symbol':'1.2-2' }}
            </h3>
          </div>
        </div>

      </div>

      <div class="modal-footer border-top border-secondary" style="background: #151515;">
        <button type="button" class="btn btn-outline-light btn-sm me-auto" 
                (click)="descargarPdf(pedidoSeleccionado.id)">
            <i class="bi bi-file-earmark-pdf me-1"></i> Descargar PDF
        </button>
        <button type="button" class="btn masterserv-btn-success px-4" (click)="cerrarModal()">
            Cerrar
        </button>
      </div>
    </div>
  </div>
</div>