<div class="container-fluid p-4">
  
  <h3 class="text-white mb-4">
    <i class="bi bi-person-gear me-2 text-danger"></i>Mi Perfil
  </h3>

  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-danger" role="status"></div>
  </div>

  <div class="row g-4" *ngIf="!isLoading">
    
    <div class="col-lg-7">
      <div class="card masterserv-card h-100">
        <div class="card-header masterserv-card-header">
          <h5 class="masterserv-title fs-6 mb-0">Información Personal</h5>
        </div>
        <div class="card-body masterserv-card-body">
          
          <form [formGroup]="perfilForm" (ngSubmit)="onSubmitPerfil()">
            
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label class="form-label masterserv-label">Nombre <span class="text-danger">*</span></label>
                <input type="text" class="form-control masterserv-input" formControlName="nombre"
                       (input)="validarInputTexto($event)"
                       [class.is-invalid]="perfilForm.get('nombre')?.invalid && perfilForm.get('nombre')?.touched">
                <div class="invalid-feedback">Requerido (solo letras).</div>
              </div>
              
              <div class="col-md-6">
                <label class="form-label masterserv-label">Apellido <span class="text-danger">*</span></label>
                <input type="text" class="form-control masterserv-input" formControlName="apellido"
                       (input)="validarInputTexto($event)"
                       [class.is-invalid]="perfilForm.get('apellido')?.invalid && perfilForm.get('apellido')?.touched">
                <div class="invalid-feedback">Requerido (solo letras).</div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label masterserv-label">Email (No editable)</label>
              <div class="input-group">
                 <span class="input-group-text masterserv-input border-end-0"><i class="bi bi-envelope-fill text-muted"></i></span>
                 <input type="email" class="form-control masterserv-input border-start-0" formControlName="email">
              </div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-4">
                <label class="form-label masterserv-label">Tipo Doc.</label>
                <select class="form-select masterserv-input" formControlName="tipoDocumentoId"
                        [class.is-invalid]="perfilForm.get('tipoDocumentoId')?.invalid && perfilForm.get('tipoDocumentoId')?.touched">
                   <option [ngValue]="null">Seleccione...</option>
                   <option *ngFor="let t of tiposDocumento" [ngValue]="t.id">{{ t.nombreCorto }}</option>
                </select>
                <div class="invalid-feedback">Requerido.</div>
              </div>
              <div class="col-md-8">
                <label class="form-label masterserv-label">Número <span class="text-danger">*</span></label>
                <input type="text" class="form-control masterserv-input" formControlName="documento"
                       maxlength="11"
                       (input)="validarInputNumerico($event)"
                       [class.is-invalid]="perfilForm.get('documento')?.invalid && perfilForm.get('documento')?.touched">
                <div class="invalid-feedback">Requerido (solo números, 7-11 dígitos).</div>
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label masterserv-label">Teléfono / Celular (Whatsapp) <span class="text-danger">*</span></label>
              <div class="input-group">
                  <select class="form-select masterserv-input text-center" formControlName="codigoPais" style="max-width: 110px;">
                      <option *ngFor="let pais of paises" [value]="pais.codigo">
                          {{ pais.bandera }} {{ pais.codigo }}
                      </option>
                  </select>
                  <input type="tel" class="form-control masterserv-input" formControlName="telefono"
                         placeholder="Ej: 11 1234 5678"
                         maxlength="15"
                         (input)="validarInputNumerico($event)"
                         [class.is-invalid]="perfilForm.get('telefono')?.invalid && perfilForm.get('telefono')?.touched">
              </div>
              <div class="d-block invalid-feedback" *ngIf="perfilForm.get('telefono')?.invalid && perfilForm.get('telefono')?.touched">
                  Requerido (solo números, mín 8).
              </div>
              <div class="form-text text-white-50 small mt-1" *ngIf="perfilForm.get('codigoPais')?.value === '+54'">
                  <i class="bi bi-info-circle me-1"></i> Para Argentina, el sistema agregará automáticamente el "9" si lo olvidas.
              </div>
            </div>

            <div class="text-end border-top border-secondary pt-3">
              <button type="submit" class="btn masterserv-btn-primary px-4" [disabled]="perfilForm.invalid || isSubmitting || perfilForm.pristine">
                <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-1"></span>
                Guardar Cambios
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card masterserv-card h-100 border-danger" style="border: 1px solid #dc3545;">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0 fw-bold fs-6"><i class="bi bi-shield-lock-fill me-2"></i>Seguridad</h5>
        </div>
        <div class="card-body masterserv-card-body">
          
          <form [formGroup]="passwordForm" (ngSubmit)="onSubmitPassword()">
            
            <div class="mb-3">
              <label class="form-label masterserv-label">Contraseña Actual</label>
              <div class="input-group">
                  <input [type]="hideActual ? 'password' : 'text'" class="form-control masterserv-input" formControlName="passwordActual">
                  <button class="btn btn-outline-secondary masterserv-input" type="button" (click)="toggleActual()">
                      <i class="bi" [ngClass]="hideActual ? 'bi-eye-slash' : 'bi-eye'"></i>
                  </button>
              </div>
            </div>

            <hr class="border-secondary my-4">

            <div class="mb-3">
              <label class="form-label masterserv-label">Nueva Contraseña</label>
              <div class="input-group">
                  <input [type]="hideNueva ? 'password' : 'text'" class="form-control masterserv-input" formControlName="passwordNueva"
                         [class.is-invalid]="passwordForm.get('passwordNueva')?.invalid && passwordForm.get('passwordNueva')?.touched">
                  <button class="btn btn-outline-secondary masterserv-input" type="button" (click)="toggleNueva()">
                      <i class="bi" [ngClass]="hideNueva ? 'bi-eye-slash' : 'bi-eye'"></i>
                  </button>
                  <div class="invalid-feedback">Mínimo 6 caracteres.</div>
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label masterserv-label">Repetir Nueva</label>
              <div class="input-group">
                  <input [type]="hideRepetir ? 'password' : 'text'" class="form-control masterserv-input" formControlName="passwordRepetir"
                         [class.is-invalid]="passwordForm.errors?.['mismatch'] && passwordForm.get('passwordRepetir')?.touched">
                  <button class="btn btn-outline-secondary masterserv-input" type="button" (click)="toggleRepetir()">
                      <i class="bi" [ngClass]="hideRepetir ? 'bi-eye-slash' : 'bi-eye'"></i>
                  </button>
                  <div class="invalid-feedback">Las contraseñas no coinciden.</div>
              </div>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-outline-light" [disabled]="passwordForm.invalid || isSubmittingPass">
                <span *ngIf="isSubmittingPass" class="spinner-border spinner-border-sm me-1"></span>
                Actualizar Contraseña
              </button>
            </div>

          </form>

        </div>
      </div>
    </div>

  </div>
</div>