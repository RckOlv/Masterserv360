<div class="pos-container">
  <div class="row g-3">

    <div class="col-lg-7 d-flex flex-column">

      <form [formGroup]="productoSearchForm" (ngSubmit)="agregarAlCarrito()" class="p-3 masterserv-filter rounded border mb-3">
        <h5 class="masterserv-label mb-3"><i class="bi bi-search me-2"></i>Buscar Producto</h5>
        <div class="row g-2 align-items-center">
          <div class="col-sm-8">
            <label for="productoSelect" class="form-label visually-hidden">Producto</label>
            <ng-select
              id="productoSelect"
              class="masterserv-input" 
              formControlName="productoSeleccionado"
              [items]="(productos$ | async) ?? []"
              [typeahead]="productoSearch$"
              bindLabel="nombre"
              placeholder="Escriba nombre o código del producto..."
              [loading]="isLoadingProductos">
              <ng-template ng-option-tmp let-item="item">
                <div>{{item.nombre}}</div>
                <small class="text-muted">Código: {{item.codigo}} | Precio: {{item.precioVenta | currency:'ARS':'symbol':'1.2-2'}} | Stock: {{item.stockActual}}</small>
              </ng-template>
              <ng-template ng-notfound-tmp let-searchTerm="searchTerm">
                <div class="ng-option-disabled">No se encontraron productos para "{{searchTerm}}"</div>
              </ng-template>
            </ng-select>
          </div>
          <div class="col-sm-2">
            <label for="cantidadAgregar" class="form-label visually-hidden">Cantidad</label>
            <input type="number" id="cantidadAgregar" class="form-control text-center masterserv-input"
                   formControlName="cantidadAgregar" min="1">
          </div>
          <div class="col-sm-2 d-grid">
            <button class="btn masterserv-btn-primary" type="submit" [disabled]="productoSearchForm.invalid || isLoadingCarrito">
              <i class="bi bi-cart-plus"></i> Agregar
            </button>
          </div>
        </div>
      </form>

      <div class="card masterserv-card flex-grow-1">
        <div class="card-header masterserv-card-header">
          <h5 class="masterserv-title mb-0"><i class="bi bi-cart3 me-2"></i>Carrito Actual</h5>
        </div>
        <div class="card-body masterserv-card-body p-0 d-flex flex-column">
          
          <div *ngIf="isLoadingCarrito" class="loading-container flex-grow-1 d-flex align-items-center justify-content-center">
            <div class="spinner-border masterserv-spinner" role="status">
              <span class="visually-hidden">Cargando carrito...</span>
            </div>
          </div>
          
          <div *ngIf="!isLoadingCarrito && carrito">
            
            <div *ngIf="!carrito.items || carrito.items.length === 0" class="empty-container m-3">
              <div class="alert masterserv-alert-info text-center">
                El carrito está vacío.
              </div>
            </div>

            <div class="table-responsive" *ngIf="carrito.items && carrito.items.length > 0">
              <table class="table table-hover table-sm align-middle masterserv-table mb-0">
                <thead class="masterserv-table-header">
                  <tr>
                    <th class="ps-3 masterserv-header-producto">Producto</th>
                    <th class="text-end">Precio U.</th>
                    <th class="text-center" style="width: 100px;">Cantidad</th>
                    <th class="text-end">Subtotal</th>
                    <th class="text-center">Stock</th>
                    <th class="text-center pe-3"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of carrito.items" class="masterserv-table-row">
                    <td class="masterserv-name ps-3">
                      <div>{{ item.productoNombre }}</div>
                      <small class="masterserv-code">{{ item.productoCodigo }}</small>
                    </td>
                    <td class="masterserv-price text-end">{{ item.precioUnitarioVenta | currency:'ARS':'symbol':'1.2-2' }}</td>
                    <td class="text-center">
                      <input type="number"
                             class="form-control form-control-sm text-center masterserv-input"
                             [value]="item.cantidad"
                             min="0"
                             (change)="actualizarCantidadCarrito(item, $event)"
                             [disabled]="isLoadingCarrito || isFinalizandoVenta"
                             style="width: 80px; display: inline-block;">
                    </td>
                    <td class="masterserv-price text-end fw-bold">{{ item.subtotal | currency:'ARS':'symbol':'1.2-2' }}</td>
                    <td class="text-center">
                      <span class="badge masterserv-badge" [ngClass]="item.cantidad > item.stockDisponible ? 'masterserv-badge-danger' : 'masterserv-badge-success'">
                        {{ item.stockDisponible }}
                      </span>
                    </td>
                    <td class="text-center pe-3">
                      <button class="btn masterserv-btn-outline-danger btn-sm py-0 px-1"
                              (click)="quitarDelCarrito(item)"
                              [disabled]="isLoadingCarrito || isFinalizandoVenta"
                              title="Quitar">
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div> 
    
    <div class="col-lg-5">
      <div class="card masterserv-card shadow-sm sticky-top" style="top: 1rem;">
       <div class="card-header masterserv-card-header">
         <h5 class="masterserv-title mb-0"><i class="bi bi-person-check me-2"></i>Cliente y Total</h5>
       </div>
       <div class="card-body masterserv-card-body" [formGroup]="clienteForm">
         <div class="mb-3">
           <label for="clienteSelect" class="form-label masterserv-label">Cliente <span class="text-danger">*</span></label>
           <ng-select
             id="clienteSelect"
             class="masterserv-input"
             formControlName="clienteId"
             [items]="(clientes$ | async) ?? []"
             [typeahead]="clienteSearch$"
             bindLabel="nombre"
             bindValue="id"
             placeholder="Buscar cliente por Nombre, Email o DNI..."
             [loading]="isLoadingClientes"
             [ngClass]="{ 'is-invalid': clienteForm.get('clienteId')?.invalid && clienteForm.get('clienteId')?.touched }">
           
             <ng-template ng-option-tmp let-item="item">
               <div>{{item.nombre}} {{item.apellido}}</div>
               <small class="text-muted">{{item.email}} - Doc: {{item.documento}}</small>
             </ng-template>

             <ng-template ng-label-tmp let-item="item">
               <span>{{item.nombre}} {{item.apellido}} (Doc: {{item.documento}})</span>
             </ng-template>
             <ng-template ng-notfound-tmp let-searchTerm="searchTerm">
               <div class="ng-option-disabled">No se encontraron clientes</div>
             </ng-template>
           </ng-select>
           <div *ngIf="clienteForm.get('clienteId')?.invalid && clienteForm.get('clienteId')?.touched"
                class="invalid-feedback d-block">
             Debe seleccionar un cliente.
           </div>
         </div>

         <div class="mb-3">
          <label for="codigoCupon" class="form-label masterserv-label">Código de Cupón (Opcional)</label>
          <input type="text" 
                 id="codigoCupon" 
                 class="form-control masterserv-input" 
                 formControlName="codigoCupon"
                 placeholder="Ej: CANJE-1-ABCD">
         </div>
         <div class="text-end border-top border-metal pt-3 mt-3" *ngIf="carrito && carrito.items && carrito.items.length > 0">
           <p class="mb-1 text-metal">Items: {{ carrito.cantidadItems }}</p>
           <h3 class="mb-0 fw-bold masterserv-price">TOTAL: {{ carrito.totalCarrito | currency:'ARS':'symbol':'1.2-2' }}</h3>
         </div>

       </div>
       <div class="card-footer d-flex justify-content-between">
         <button class="btn masterserv-btn-secondary"
                 (click)="vaciarCarrito()"
                 [disabled]="isLoadingCarrito || isFinalizandoVenta || !carrito?.items?.length">
           <i class="bi bi-cart-x"></i> Vaciar
         </button>
         <button class="btn masterserv-btn-success btn-lg"
                 (click)="finalizarVenta()"
                 [disabled]="isLoadingCarrito || isFinalizandoVenta || clienteForm.invalid || !carrito?.items?.length">
           <span *ngIf="!isFinalizandoVenta"><i class="bi bi-check-lg"></i> Finalizar Venta</span>
           <span *ngIf="isFinalizandoVenta" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
           <span *ngIf="isFinalizandoVenta"> Procesando...</span>
         </button>
       </div>
      </div>
    </div> 
  </div> 
</div>