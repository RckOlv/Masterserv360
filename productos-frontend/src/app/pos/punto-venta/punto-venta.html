<div class="container-fluid my-4">
  <h4><i class="bi bi-shop-window"></i> Punto de Venta</h4>
  <hr>

  <div *ngIf="errorMessage && !isLoadingCarrito" class="alert alert-danger">{{ errorMessage }}</div>

  <div class="row g-3">

    <div class="col-lg-7">
      <div class="card shadow-sm mb-3">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-search"></i> Buscar Producto</h5>
        </div>
        <div class="card-body" [formGroup]="productoSearchForm">
          <div class="row g-2 align-items-center">
            <div class="col-sm-8">
              <label for="productoSelect" class="form-label visually-hidden">Producto</label>
              <ng-select
                  id="productoSelect"
                  formControlName="productoSeleccionado"
                  [items]="(productos$ | async) ?? []"
                  [typeahead]="productoSearch$"
                  bindLabel="nombre"
                  placeholder="Escriba nombre o código del producto..."
                  [loading]="isLoadingProductos"
                  >
                  <ng-template ng-option-tmp let-item="item">
                    <div>{{item.nombre}}</div>
                    <small class="text-muted">Código: {{item.codigo}} | Precio: {{item.precioVenta | currency:'ARS':'symbol':'1.2-2'}} | Stock: {{item.stockActual}}</small>
                  </ng-template>
                  <ng-template ng-notfound-tmp let-searchTerm="searchTerm">
                    <div class="ng-option-disabled">No se encontraron productos para "{{searchTerm}}"</div>
                  </ng-template>
              </ng-select>
              <div *ngIf="productoSearchForm.get('productoSeleccionado')?.invalid && productoSearchForm.get('productoSeleccionado')?.touched"
                   class="invalid-feedback d-block">
                Debe seleccionar un producto.
              </div>
            </div>
            <div class="col-sm-2">
              <label for="cantidadAgregar" class="form-label visually-hidden">Cantidad</label>
              <input type="number" id="cantidadAgregar" class="form-control text-center"
                     formControlName="cantidadAgregar" min="1">
            </div>
            <div class="col-sm-2 d-grid">
              <button class="btn btn-primary" type="button" (click)="agregarAlCarrito()" [disabled]="productoSearchForm.invalid || isLoadingCarrito">
                <i class="bi bi-cart-plus"></i> Agregar
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-cart3"></i> Carrito Actual</h5>
        </div>
        <div class="card-body p-0">
          <div *ngIf="isLoadingCarrito" class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando carrito...</span>
            </div>
          </div>
          <div *ngIf="!isLoadingCarrito && carrito">
            <div *ngIf="!carrito.items || carrito.items.length === 0" class="alert alert-secondary m-3 text-center">
              El carrito está vacío.
            </div>
            <div class="table-responsive" *ngIf="carrito.items && carrito.items.length > 0">
              <table class="table table-hover table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Producto</th>
                    <th class="text-end">Precio U.</th>
                    <th class="text-center" style="width: 120px;">Cantidad</th>
                    <th class="text-end">Subtotal</th>
                    <th class="text-center">Stock</th>
                    <th class="text-center"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of carrito.items">
                    <td>
                      <div>{{ item.productoNombre }}</div>
                      <small class="text-muted">{{ item.productoCodigo }}</small>
                    </td>
                    <td class="text-end">{{ item.precioUnitarioVenta | currency:'ARS':'symbol':'1.2-2' }}</td>
                    <td class="text-center">
                      <input type="number"
                             class="form-control form-control-sm text-center"
                             [value]="item.cantidad"
                             min="0"
                             (change)="actualizarCantidadCarrito(item, $event)"
                             [disabled]="isLoadingCarrito || isFinalizandoVenta"
                             style="width: 80px; display: inline-block;">
                    </td>
                    <td class="text-end fw-bold">{{ item.subtotal | currency:'ARS':'symbol':'1.2-2' }}</td>
                    <td class="text-center">
                       <span class="badge" [ngClass]="item.cantidad > item.stockDisponible ? 'bg-danger' : 'bg-success'">
                         {{ item.stockDisponible }}
                       </span>
                    </td>
                    <td class="text-center">
                      <button class="btn btn-outline-danger btn-sm py-0 px-1"
                              (click)="quitarDelCarrito(item)"
                              [disabled]="isLoadingCarrito || isFinalizandoVenta"
                              title="Quitar">
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div> <div class="col-lg-5">
       <div class="card shadow-sm sticky-top" style="top: 1rem;">
        <div class="card-header">
           <h5 class="mb-0"><i class="bi bi-person-check"></i> Cliente y Total</h5>
        </div>
        <div class="card-body" [formGroup]="clienteForm">
          <div class="mb-3">
            <label for="clienteSelect" class="form-label">Cliente <span class="text-danger">*</span></label>
            <ng-select
                id="clienteSelect"
                formControlName="clienteId"
                [items]="(clientes$ | async) ?? []"
                [typeahead]="clienteSearch$"
                bindLabel="nombre"
                bindValue="id"
                placeholder="Buscar cliente..."
                [loading]="isLoadingClientes"
                [ngClass]="{ 'is-invalid': clienteForm.get('clienteId')?.invalid && clienteForm.get('clienteId')?.touched }">
                <ng-template ng-option-tmp let-item="item">
                  <div>{{item.nombre}} {{item.apellido}}</div>
                  <small class="text-muted">{{item.email}} - Doc: {{item.documento}}</small>
                </ng-template>
                 <ng-template ng-notfound-tmp let-searchTerm="searchTerm">
                   <div class="ng-option-disabled">No se encontraron clientes para "{{searchTerm}}"</div>
                 </ng-template>
            </ng-select>
            <div *ngIf="clienteForm.get('clienteId')?.invalid && clienteForm.get('clienteId')?.touched"
                 class="invalid-feedback d-block">
              Debe seleccionar un cliente.
            </div>
          </div>
          <div class="text-end border-top pt-3 mt-3" *ngIf="carrito && carrito.items && carrito.items.length > 0">
             <p class="mb-1 text-muted">Items: {{ carrito.cantidadItems }}</p>
             <h3 class="mb-0 fw-bold">TOTAL: {{ carrito.totalCarrito | currency:'ARS':'symbol':'1.2-2' }}</h3>
          </div>
        </div>
        <div class="card-footer d-flex justify-content-between">
           <button class="btn btn-outline-secondary"
                   (click)="vaciarCarrito()"
                   [disabled]="isLoadingCarrito || isFinalizandoVenta || !carrito?.items?.length">
             <i class="bi bi-cart-x"></i> Vaciar
           </button>
           <button class="btn btn-success btn-lg"
                   (click)="finalizarVenta()"
                   [disabled]="isLoadingCarrito || isFinalizandoVenta || clienteForm.invalid || !carrito?.items?.length">
              <span *ngIf="!isFinalizandoVenta"><i class="bi bi-check-lg"></i> Finalizar Venta</span>
              <span *ngIf="isFinalizandoVenta" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              <span *ngIf="isFinalizandoVenta"> Procesando...</span>
           </button>
        </div>
      </div>
    </div> </div> </div>