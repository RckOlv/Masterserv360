<div class="pos-container">
  <div class="row g-3">

    <div class="col-lg-7 d-flex flex-column">

      <form [formGroup]="productoSearchForm" (ngSubmit)="agregarAlCarrito()" class="p-3 masterserv-filter rounded border mb-3">
        <h5 class="masterserv-label mb-3"><i class="bi bi-search me-2"></i>Buscar Producto</h5>
        <div class="row g-2 align-items-center">
          <div class="col-sm-8">
            <label for="productoSelect" class="form-label visually-hidden">Producto</label>
            <ng-select
              id="productoSelect"
              class="masterserv-select-dark custom-dark-select" 
              formControlName="productoSeleccionado"
              [items]="(productos$ | async) ?? []"
              [typeahead]="productoSearch$"
              bindLabel="nombre"
              placeholder="Escriba nombre o código del producto..."
              [loading]="isLoadingProductos">
              <ng-template ng-option-tmp let-item="item">
                <div class="text-white">{{item.nombre}}</div>
                <small class="text-muted">Código: {{item.codigo}} | Precio: {{item.precioVenta | currency:'ARS':'symbol':'1.2-2'}} | Stock: {{item.stockActual}}</small>
              </ng-template>
              <ng-template ng-notfound-tmp let-searchTerm="searchTerm">
                <div class="ng-option-disabled text-white-50">No se encontraron productos para "{{searchTerm}}"</div>
              </ng-template>
            </ng-select>
          </div>
          <div class="col-sm-2">
            <label for="cantidadAgregar" class="form-label visually-hidden">Cantidad</label>
            <input type="number" id="cantidadAgregar" class="form-control text-center masterserv-input-dark"
                   formControlName="cantidadAgregar" min="1">
          </div>
          <div class="col-sm-2 d-grid">
            <button class="btn masterserv-btn-primary" type="submit" [disabled]="productoSearchForm.invalid || isLoadingCarrito">
              <i class="bi bi-cart-plus"></i> Agregar
            </button>
          </div>
        </div>
      </form>

      <div class="card masterserv-card flex-grow-1">
        <div class="card-header masterserv-card-header">
          <h5 class="masterserv-title mb-0"><i class="bi bi-cart3 me-2"></i>Carrito Actual</h5>
        </div>
        <div class="card-body masterserv-card-body p-0 d-flex flex-column">
          
          <div *ngIf="isLoadingCarrito" class="loading-container flex-grow-1 d-flex align-items-center justify-content-center">
            <div class="spinner-border masterserv-spinner" role="status">
              <span class="visually-hidden">Cargando carrito...</span>
            </div>
          </div>
          
          <div *ngIf="!isLoadingCarrito && carrito">
            
            <div *ngIf="!carrito.items || carrito.items.length === 0" class="empty-container m-3">
              <div class="alert masterserv-alert-info text-center">
                El carrito está vacío.
              </div>
            </div>

            <div class="table-responsive" *ngIf="carrito.items && carrito.items.length > 0">
              <table class="table table-hover table-sm align-middle masterserv-table mb-0">
                <thead class="masterserv-table-header">
                  <tr>
                    <th class="ps-3 masterserv-header-producto">Producto</th>
                    <th class="text-end">Precio U.</th>
                    <th class="text-center" style="width: 100px;">Cantidad</th>
                    <th class="text-end">Subtotal</th>
                    <th class="text-center">Stock</th>
                    <th class="text-center pe-3"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of carrito.items" class="masterserv-table-row">
                    <td class="masterserv-name ps-3">
                      <div class="text-white fw-bold">{{ item.productoNombre }}</div>
                      <small class="masterserv-code text-white-50">{{ item.productoCodigo }}</small>
                    </td>
                    
                    <td class="text-end text-warning font-monospace">
                        {{ item.precioUnitarioVenta | currency:'ARS':'symbol':'1.2-2' }}
                    </td>
                    
                    <td class="text-center">
                      <input type="number"
                             class="form-control form-control-sm text-center masterserv-input-dark"
                             [value]="item.cantidad"
                             min="0"
                             (change)="actualizarCantidadCarrito(item, $event)"
                             [disabled]="isLoadingCarrito || isFinalizandoVenta"
                             style="width: 80px; display: inline-block;">
                    </td>
                    
                    <td class="text-end fw-bold text-white fs-6 font-monospace">
                        {{ item.subtotal | currency:'ARS':'symbol':'1.2-2' }}
                    </td>
                    
                    <td class="text-center">
                      <span class="badge masterserv-badge" [ngClass]="item.cantidad > item.stockDisponible ? 'masterserv-badge-danger' : 'masterserv-badge-success'">
                        {{ item.stockDisponible }}
                      </span>
                    </td>
                    <td class="text-center pe-3">
                      <button class="btn masterserv-btn-outline-danger btn-sm py-0 px-1"
                              (click)="quitarDelCarrito(item)"
                              [disabled]="isLoadingCarrito || isFinalizandoVenta"
                              title="Quitar">
                        <i class="bi bi-x-lg"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div> 
    
    <div class="col-lg-5">
      <div class="card masterserv-card shadow-lg sticky-top border-danger" style="top: 1rem; background-color: #1e1e1e;">
        
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0 fw-bold"><i class="bi bi-person-check-fill me-2"></i>Cliente y Total</h5>
        </div>
        
        <div class="card-body masterserv-card-body text-white" [formGroup]="clienteForm">
          
          <div class="mb-3">
            <label for="clienteSelect" class="form-label text-danger small fw-bold text-uppercase">Cliente *</label>
            
            <div class="d-flex gap-2">
              <ng-select
                id="clienteSelect"
                class="masterserv-select-dark custom-dark-select flex-grow-1" 
                formControlName="clienteId"
                [items]="(clientes$ | async) ?? []"
                [typeahead]="clienteSearch$"
                bindLabel="nombre"
                bindValue="id"
                placeholder="Buscar cliente por nombre o DNI..."
                [loading]="isLoadingClientes">
                
                <ng-template ng-option-tmp let-item="item">
                  <div class="text-white">{{item.nombre}} {{item.apellido}}</div>
                  <small class="text-muted">{{item.email}} - Doc: {{item.documento}}</small>
                </ng-template>
  
                <ng-template ng-label-tmp let-item="item">
                  <span class="text-white fw-bold">
                    {{item.nombre}} {{item.apellido}} 
                    <small class="text-white-50 ms-2 fw-normal">(DNI: {{item.documento}})</small>
                  </span>
                </ng-template>
              </ng-select>

              <button class="btn btn-outline-success" type="button" (click)="abrirModalCliente()" title="Registrar Nuevo Cliente">
                <i class="bi bi-person-plus-fill"></i>
              </button>
            </div>
            
            <div *ngIf="clienteForm.get('clienteId')?.invalid && clienteForm.get('clienteId')?.touched"
                 class="text-danger small mt-1">
              <i class="bi bi-exclamation-circle"></i> Debe seleccionar un cliente.
            </div>
          </div>

          <div class="mb-4 p-3 rounded border border-warning position-relative" 
               *ngIf="infoFidelidad" 
               style="background: linear-gradient(135deg, #3a2c0f 0%, #1e1e1e 100%);">
               
               <span class="position-absolute top-0 end-0 badge bg-warning text-dark m-2">
                   <i class="bi bi-star-fill"></i> CLUB
               </span>

               <div class="d-flex align-items-center mb-3">
                   <div class="me-3">
                       <h3 class="text-warning mb-0 fw-bold">{{ infoFidelidad.puntosAcumulados }}</h3>
                       <small class="text-white-50">Puntos</small>
                   </div>
                   <div class="border-start border-secondary ps-3">
                       <span class="text-white small d-block">Valor aprox:</span>
                       <span class="text-success fw-bold">{{ infoFidelidad.equivalenciaMonetaria }}</span>
                   </div>
               </div>

               <div *ngIf="infoFidelidad.cuponesDisponibles.length > 0" class="mb-3">
                   <label class="small text-white-50 mb-1"><i class="bi bi-ticket-perforated"></i> Cupones Listos:</label>
                   <div class="d-flex flex-wrap gap-2">
                       <button *ngFor="let c of infoFidelidad.cuponesDisponibles" 
                               type="button" 
                               class="btn btn-sm btn-outline-warning d-flex align-items-center text-start"
                               (click)="usarCuponDeLista(c.codigo)"
                               [disabled]="cuponAplicado?.codigo === c.codigo">
                           <div class="lh-1">
                               <span class="fw-bold d-block">
                                   {{ c.tipoDescuento === 'PORCENTAJE' ? c.valor + '%' : '$' + c.valor }} OFF
                               </span>
                               <span class="small" style="font-size: 0.7rem;">
                                   {{ c.categoriaNombre ? 'en ' + c.categoriaNombre : 'en Total' }}
                               </span>
                           </div>
                           <i class="bi bi-check-lg ms-2" *ngIf="cuponAplicado?.codigo === c.codigo"></i>
                       </button>
                   </div>
               </div>
               
               <div *ngIf="infoFidelidad.recompensasAlcanzables && infoFidelidad.recompensasAlcanzables.length > 0">
                   <hr class="border-secondary my-2">
                   <label class="small text-white-50 mb-1"><i class="bi bi-gift"></i> Canjear Ahora:</label>
                   <div class="d-flex flex-wrap gap-2">
                       <button *ngFor="let r of infoFidelidad.recompensasAlcanzables"
                               type="button"
                               class="btn btn-sm btn-dark border-secondary d-flex align-items-center"
                               (click)="canjearRecompensaEnPos(r)">
                           <span class="text-white me-2">{{ r.descripcion }}</span>
                           <span class="badge bg-warning text-dark rounded-pill">{{ r.puntosRequeridos }} pts</span>
                       </button>
                   </div>
               </div>

               <div *ngIf="infoFidelidad.cuponesDisponibles.length === 0 && infoFidelidad.recompensasAlcanzables && infoFidelidad.recompensasAlcanzables.length === 0" 
                    class="small text-muted fst-italic mt-2">
                   El cliente no tiene cupones ni puntos suficientes.
               </div>
          </div>

          <hr class="border-secondary">

          <div class="mb-4">
            <label class="form-label text-danger small fw-bold text-uppercase">Código de Cupón (Manual)</label>
            <div class="input-group">
              <input type="text" 
                     class="form-control masterserv-input-dark" 
                     formControlName="codigoCupon"
                     placeholder="Ej: CANJE-8-123A"
                     [readonly]="cuponAplicado"
                     (keyup.enter)="aplicarCupon()">
              
              <button *ngIf="!cuponAplicado" 
                      class="btn btn-outline-light" 
                      type="button" 
                      (click)="aplicarCupon()"
                      [disabled]="isValidandoCupon">
                {{ isValidandoCupon ? '...' : 'Aplicar' }}
              </button>
              
              <button *ngIf="cuponAplicado" 
                      class="btn btn-danger" 
                      type="button" 
                      (click)="quitarCupon()">
                <i class="bi bi-trash-fill"></i>
              </button>
            </div>
          </div>

          <div *ngIf="cuponAplicado" class="alert alert-success border-0 py-2 px-3 small mb-3 d-flex align-items-center shadow-sm" style="background-color: #d1e7dd; color: #0f5132;">
            <i class="bi bi-tag-fill me-2 fs-5"></i>
            <div>
              <strong>¡Cupón Aplicado!</strong><br>
              <span *ngIf="cuponAplicado.tipoDescuento === 'PORCENTAJE'">Descuento del {{ cuponAplicado.valor }}%</span>
              <span *ngIf="cuponAplicado.tipoDescuento === 'FIJO'">Descuento fijo de ${{ cuponAplicado.valor }}</span>
              <span *ngIf="cuponAplicado.categoriaNombre" class="d-block small">Válido en: {{ cuponAplicado.categoriaNombre }}</span>
            </div>
          </div>

          <div class="p-3 rounded" style="background-color: #2c2c2c;" *ngIf="carrito && carrito.items && carrito.items.length > 0">
            
            <div class="d-flex justify-content-between mb-2">
              <span class="text-white-50">Subtotal:</span>
              <span class="fw-bold text-white">{{ carrito.totalCarrito | currency:'ARS':'symbol':'1.2-2' }}</span>
            </div>

            <div class="d-flex justify-content-between mb-2 text-success" *ngIf="montoDescuento > 0">
              <span>Descuento:</span>
              <span class="fw-bold">- {{ montoDescuento | currency:'ARS':'symbol':'1.2-2' }}</span>
            </div>

            <hr class="border-secondary my-2">

            <div class="d-flex justify-content-between align-items-center mt-3">
              <span class="h5 mb-0 text-white opacity-75">TOTAL:</span>
              <span class="h2 mb-0 text-danger fw-bold">{{ totalFinal | currency:'ARS':'symbol':'1.2-2' }}</span>
            </div>
            <p class="text-end text-white-50 small mb-0 mt-1">Items: {{ carrito.cantidadItems }}</p>

          </div>

        </div>
        
        <div class="card-footer bg-transparent border-top border-secondary d-grid gap-2 p-3">
          
          <button class="btn btn-outline-danger"
                  (click)="vaciarCarrito()"
                  [disabled]="isLoadingCarrito || isFinalizandoVenta || !carrito?.items?.length">
            <i class="bi bi-trash me-2"></i> Vaciar Carrito
          </button>
          
          <button class="btn btn-success btn-lg fw-bold shadow"
                  (click)="finalizarVenta()"
                  [disabled]="isLoadingCarrito || isFinalizandoVenta || clienteForm.invalid || !carrito?.items?.length">
            <span *ngIf="!isFinalizandoVenta"><i class="bi bi-check-circle-fill me-2"></i> CONFIRMAR VENTA</span>
            <span *ngIf="isFinalizandoVenta" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          </button>
        </div>

      </div>
    </div> 
  </div> 
</div>

<div class="modal fade" id="modalNuevoCliente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="background-color: #1e1e1e; border: 1px solid #dc3545; color: white;">
        
        <div class="modal-header border-secondary">
          <h5 class="modal-title text-danger fw-bold">
            <i class="bi bi-person-plus me-2"></i>Nuevo Cliente
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        
        <div class="modal-body">
          <form [formGroup]="nuevoClienteForm">
             <div class="row g-2">
              <div class="col-6">
                <label class="small text-white">Nombre *</label>
                <input type="text" class="form-control masterserv-input-dark" formControlName="nombre" (input)="validarInputTexto($event)">
              </div>
              <div class="col-6">
                <label class="small text-white">Apellido *</label>
                <input type="text" class="form-control masterserv-input-dark" formControlName="apellido" (input)="validarInputTexto($event)">
              </div>
            </div>
  
            <div class="row g-2 mt-2">
                <div class="col-4">
                    <label class="small text-white">Tipo *</label>
                    <select class="form-control masterserv-input-dark" formControlName="tipoDocumentoBusqueda">
                        <option value="DNI">DNI</option>
                        <option value="CUIT">CUIT</option>
                        <option value="CUIL">CUIL</option>
                        <option value="PAS">PASAPORTE</option>
                    </select>
                </div>
                <div class="col-8">
                    <label class="small text-white">Número *</label>
                    <input type="text" class="form-control masterserv-input-dark" formControlName="documento" (input)="validarInputNumerico($event)">
                </div>
            </div>
  
            <div class="mt-2">
              <label class="small text-white">Email *</label>
              <input type="email" class="form-control masterserv-input-dark" formControlName="email">
            </div>
            
            <div class="mt-2">
              <label class="small text-white">Teléfono / Celular *</label>
              <div class="input-group input-group-sm">
                  <select class="form-control masterserv-input-dark" formControlName="codigoPais" style="max-width: 90px;">
                      <option *ngFor="let pais of paises" [value]="pais.codigo">
                          {{ pais.bandera }} {{ pais.codigo }}
                      </option>
                  </select>
                  <input type="text" class="form-control masterserv-input-dark" 
                         formControlName="telefono" 
                         placeholder="Sin 0 ni 15"
                         maxlength="15"
                         (input)="validarInputNumerico($event)">
              </div>
            </div>
            
            <div class="mt-3 p-2 rounded" style="background-color: #2c2c2c; font-size: 0.8rem; color: #aaa;">
                <i class="bi bi-info-circle me-1"></i> Se asignará la contraseña <strong>123456</strong> por defecto.
            </div>
  
          </form>
        </div>
        
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" (click)="guardarNuevoCliente()" [disabled]="nuevoClienteForm.invalid || isGuardandoCliente">
            <span *ngIf="isGuardandoCliente" class="spinner-border spinner-border-sm me-1"></span>
            Guardar Cliente
          </button>
        </div>
  
      </div>
    </div>
</div>