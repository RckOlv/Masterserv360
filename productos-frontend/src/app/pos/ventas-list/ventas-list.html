<div class="container-fluid my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4><i class="bi bi-receipt"></i> Historial de Ventas</h4>
    <a *appHasPermission="'VENTAS_CREATE'" routerLink="/pos/punto-venta" class="btn btn-primary">
      <i class="bi bi-plus-lg"></i> Nueva Venta
    </a>
  </div>

  <div class="card card-masterserv shadow-sm mb-3">
    <div class="card-body bg-dark-custom p-3 rounded-2">
      <form [formGroup]="filtroForm" (ngSubmit)="aplicarFiltros(true)">
        <div class="row g-2 align-items-end">
          
          <div class="col-md-3">
            <label for="filtroCliente" class="form-label form-label-sm">Cliente</label>
            <ng-select
              id="filtroCliente"
              formControlName="clienteId"
              [items]="(clientes$ | async) ?? []"
              [typeahead]="clienteSearch$"
              bindLabel="nombre"
              bindValue="id"
              placeholder="Buscar cliente..."
              [loading]="isLoadingClientes"
              [clearable]="true">

              <ng-template ng-option-tmp let-item="item">
                <div>{{ item.nombre }} {{ item.apellido }}</div>
                <small class="text-muted">{{ item.email }} - Doc: {{ item.documento }}</small>
              </ng-template>

              <ng-template ng-notfound-tmp let-searchTerm="searchTerm">
                <div class="ng-option-disabled">No se encontraron clientes</div>
              </ng-template>

            </ng-select>
          </div>

          <div *appHasPermission="'VENTAS_READ_ALL'" class="col-md-3">
            <label for="filtroVendedor" class="form-label form-label-sm">Vendedor</label>
            <select id="filtroVendedor" class="form-select form-select-sm" formControlName="vendedorId" [disabled]="isLoadingFilters">
              <option [ngValue]="null">Todos</option>
              <option *ngFor="let vendedor of vendedores" [value]="vendedor.id">
                {{ vendedor.nombre }} {{ vendedor.apellido }}
              </option>
            </select>
          </div>

          <div class="col-md-2">
            <label for="filtroFechaDesde" class="form-label form-label-sm">Fecha Desde</label>
            <input type="date" id="filtroFechaDesde" class="form-control form-control-sm" formControlName="fechaDesde">
          </div>

          <div class="col-md-2">
            <label for="filtroFechaHasta" class="form-label form-label-sm">Fecha Hasta</label>
            <input type="date" id="filtroFechaHasta" class="form-control form-control-sm" formControlName="fechaHasta">
          </div>

          <div class="col-md-2">
            <label for="filtroEstado" class="form-label form-label-sm">Estado</label>
            <select id="filtroEstado" class="form-select form-select-sm" formControlName="estado">
              <option [ngValue]="null">Todos</option>
              <option *ngFor="let est of estadosVenta" [value]="est">{{ est }}</option>
            </select>
          </div>

          <div class="col-12 col-md-auto ms-md-auto mt-2 mt-md-0">
            <button type="submit" class="btn btn-primary btn-sm me-2" [disabled]="isLoadingFilters || isLoading">
              <i class="bi bi-search"></i> Buscar
            </button>
            <button type="button" class="btn btn-secondary btn-sm" (click)="limpiarFiltros()" [disabled]="isLoadingFilters || isLoading">
              <i class="bi bi-eraser"></i> Limpiar
            </button>
          </div>
        </div>
      </form>

      <div *ngIf="isLoadingFilters" class="text-center text-muted small mt-2">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        Cargando filtros...
      </div>

    </div>
  </div>

  <div *ngIf="isLoading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Cargando ventas...</span>
    </div>
  </div>

  <div *ngIf="errorMessage && !isLoading" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <div *ngIf="!isLoading && ventasPage">

    <div *ngIf="!ventasPage.content || ventasPage.content.length === 0" class="alert alert-secondary text-center">
      <i class="bi bi-info-circle me-2"></i>
      No se encontraron ventas para los filtros aplicados.
    </div>

    <div class="card card-masterserv shadow-sm" *ngIf="ventasPage.content && ventasPage.content.length > 0">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-masterserv table-hover table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>ID Venta</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Vendedor</th>
                <th class="text-end">Total</th>
                <th class="text-center">Estado</th>
                <th class="text-center">Acciones</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let venta of ventasPage.content">
                <td>#{{ venta.id }}</td>
                <td>{{ venta.fechaVenta | date:'dd/MM/yyyy HH:mm' }}</td>
                <td class="fw-bold">{{ venta.clienteNombre || 'N/A' }}</td>
                <td>{{ venta.vendedorNombre || 'N/A' }}</td>
                <td class="text-end fw-bold">{{ venta.totalVenta | currency:'ARS':'symbol':'1.2-2' }}</td>

                <td class="text-center">
                  <span class="badge"
                    [ngClass]="{
                      'bg-success': venta.estado === 'COMPLETADA',
                      'bg-danger': venta.estado === 'CANCELADA',
                      'bg-warning': venta.estado === 'PENDIENTE'
                    }">
                    {{ venta.estado }}
                  </span>
                </td>

                <td class="text-center">
                  <div class="btn-group btn-group-sm" role="group">

                    <button class="btn btn-outline-info"
                            [routerLink]="['/pos/ventas', venta.id]"
                            title="Ver Detalle"
                            (click)="$event.stopPropagation()">
                      <i class="bi bi-eye"></i>
                    </button>

                    <button *ngIf="venta.estado === 'COMPLETADA'"
                            class="btn btn-outline-primary"
                            (click)="descargarComprobante(venta.id, $event)"
                            title="Descargar Comprobante">
                      <i class="bi bi-download"></i>
                    </button>

                    <!-- FIX aplicado acá -->
                    <ng-container *appHasPermission="'VENTAS_CANCELAR'">
                      <button *ngIf="venta.estado === 'COMPLETADA'"
                              class="btn btn-outline-warning"
                              (click)="onCancelarVenta(venta)"
                              [disabled]="cancelingVentaId === venta.id"
                              title="Cancelar Venta">

                        <span *ngIf="cancelingVentaId === venta.id"
                              class="spinner-border spinner-border-sm"
                              role="status"
                              aria-hidden="true"></span>

                        <i *ngIf="cancelingVentaId !== venta.id"
                           class="bi bi-x-circle"></i>
                      </button>
                    </ng-container>

                  </div>
                </td>
              </tr>
            </tbody>

          </table>
        </div>
      </div>

      <div class="card-footer d-flex justify-content-between align-items-center"
           *ngIf="ventasPage.totalPages > 1">
        <button class="btn btn-outline-secondary btn-sm"
                (click)="paginaAnterior()"
                [disabled]="ventasPage.number === 0 || isLoading">
          <i class="bi bi-chevron-left"></i> Anterior
        </button>

        <span>
          Página {{ ventasPage.number + 1 }} de {{ ventasPage.totalPages }}
          <small class="text-muted ms-2">(Total: {{ ventasPage.totalElements }} ventas)</small>
        </span>

        <button class="btn btn-outline-secondary btn-sm"
                (click)="paginaSiguiente()"
                [disabled]="(ventasPage.number + 1) >= ventasPage.totalPages || isLoading">
          Siguiente <i class="bi bi-chevron-right"></i>
        </button>
      </div>

    </div>
  </div>
</div>
