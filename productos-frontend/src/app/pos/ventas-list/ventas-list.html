<div class="ventas-container">
  <div class="card masterserv-card">
    
    <div class="card-header masterserv-card-header d-flex justify-content-between align-items-center">
      <h4 class="masterserv-title">
        <i class="bi bi-receipt me-2"></i>Ventas
      </h4>
      <a routerLink="/pos/punto-venta" *appHasPermission="'VENTAS_CREATE'" class="btn masterserv-btn-primary">
        <i class="bi bi-plus-lg me-1"></i> Nueva Venta
      </a>
    </div>

    <div class="card-body masterserv-card-body d-flex flex-column">
      
      <form [formGroup]="filtroForm" (ngSubmit)="aplicarFiltros(true)" class="masterserv-filter p-3 mb-3 rounded border">
        <div class="row g-2 align-items-end">
          
          <div class="col-md-3">
            <label class="form-label text-white-50 small fw-bold">Cliente</label>
            
            <ng-select 
              [items]="(clientes$ | async) ?? []"
              bindLabel="nombre"
              bindValue="id"
              placeholder="Buscar cliente..."
              [typeahead]="clienteSearch$"
              [loading]="isLoadingClientes"
              [(ngModel)]="filtros.clienteId" 
              [ngModelOptions]="{standalone: true}"
              (change)="onFiltroChange()"
              class="masterserv-select-dark"
              notFoundText="No se encontraron clientes">
              
              <ng-template ng-option-tmp let-item="item">
                <div class="text-white fw-bold">{{ item.nombre }} {{ item.apellido }}</div>
                <small class="text-white-50">
                   <i class="bi bi-envelope"></i> {{ item.email }} | Doc: {{ item.documento }}
                </small>
              </ng-template>
  
              <ng-template ng-label-tmp let-item="item">
                <span class="text-white fw-bold">
                  {{ item.nombre }} {{ item.apellido }}
                </span>
              </ng-template>
            </ng-select>
          </div>

          <div class="col-md-2" *appHasPermission="'VENTAS_READ_ALL'">
            <label class="form-label text-white-50 small fw-bold">Vendedor</label>
            <select class="form-select form-select-sm masterserv-input" formControlName="vendedorId">
              <option [ngValue]="null">Todos</option>
              <option *ngFor="let v of vendedores" [value]="v.id">
                {{ v.nombre }} {{ v.apellido }}
              </option>
            </select>
          </div>

          <div class="col-md-2">
            <label class="form-label text-white-50 small fw-bold">Fecha Desde</label>
            <input type="date" class="form-control form-control-sm masterserv-input" formControlName="fechaDesde">
          </div>
          <div class="col-md-2">
            <label class="form-label text-white-50 small fw-bold">Fecha Hasta</label>
            <input type="date" class="form-control form-control-sm masterserv-input" formControlName="fechaHasta">
          </div>

          <div class="col-md-2">
            <label class="form-label text-white-50 small fw-bold">Estado</label>
            <select class="form-select form-select-sm masterserv-input" formControlName="estado">
              <option [ngValue]="null">Todos</option>
              <option *ngFor="let e of estadosVenta" [value]="e">{{ e }}</option>
            </select>
          </div>
          
          <div class="col-md-1 d-flex">
            <div class="d-grid gap-1 w-100">
              <button type="submit" class="btn masterserv-btn-primary btn-sm" title="Buscar">
                <i class="bi bi-search"></i>
              </button>
              <button type="button" class="btn masterserv-btn-secondary btn-sm" (click)="limpiarFiltros()" title="Limpiar">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          </div>

        </div>
      </form>

      <div *ngIf="isLoadingFilters" class="text-center text-white-50 small mt-2">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        Cargando filtros...
      </div>

      <div class="content-main flex-grow-1 d-flex flex-column">
        
        <div *ngIf="isLoading" class="loading-container flex-grow-1 d-flex align-items-center justify-content-center">
          <div class="spinner-border masterserv-spinner" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
        </div>

        <div *ngIf="errorMessage && !isLoading" class="alert masterserv-alert-danger mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>{{ errorMessage }}
        </div>

        <div *ngIf="!isLoading && ventasPage && ventasPage.content.length > 0" class="table-responsive flex-grow-1">
          <table class="table table-hover table-sm align-middle masterserv-table">
            <thead class="masterserv-table-header">
              <tr>
                <th class="ps-3">ID Venta</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Vendedor</th>
                <th class="text-end">Total</th>
                <th class="text-center">Estado</th>
                <th class="text-center pe-3">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let venta of ventasPage.content" class="masterserv-table-row">
                <td class="ps-3 masterserv-code fw-bold">#{{ venta.id }}</td>
                <td class="text-white">{{ venta.fechaVenta | date:'dd/MM/yyyy HH:mm' }}</td>
                
                <td class="text-white fw-bold">
                    {{ venta.clienteNombre || 'N/A' }}
                </td>
                
                <td class="text-white-50">
                    {{ venta.vendedorNombre || 'Web/Sistema' }}
                </td>
                
                <td class="text-end masterserv-price fw-bold">
                  {{ venta.totalVenta | currency:'ARS':'symbol':'1.2-2' }}
                </td>
                
                <td class="text-center">
                  <span class="badge masterserv-badge" 
                        [ngClass]="{
                          'masterserv-badge-success': venta.estado === 'COMPLETADA',
                          'masterserv-badge-danger': venta.estado === 'CANCELADA',
                          'masterserv-badge-warning': venta.estado === 'PENDIENTE'
                        }">
                    {{ venta.estado }}
                  </span>
                </td>

                <td class="text-center pe-3">
                  <div class="btn-group btn-group-sm">
                    
                    <a [routerLink]="['/pos/ventas', venta.id]" class="btn masterserv-btn-outline-info btn-action" title="Ver Detalle">
                      <i class="bi bi-eye"></i>
                    </a>
                    
                    <button *ngIf="venta.estado === 'COMPLETADA'" 
                            class="btn masterserv-btn-outline-primary btn-action" 
                            (click)="descargarComprobante(venta.id, $event)" 
                            title="Descargar Comprobante">
                      <i class="bi bi-download"></i>
                    </button>

                    <ng-container *appHasPermission="'VENTAS_CANCELAR'">
                      <button *ngIf="venta.estado === 'COMPLETADA'" 
                              class="btn masterserv-btn-outline-warning btn-action" 
                              (click)="onCancelarVenta(venta)" 
                              [disabled]="cancelingVentaId === venta.id"
                              title="Cancelar Venta">
                         <i *ngIf="cancelingVentaId !== venta.id" class="bi bi-x-circle"></i>
                         <span *ngIf="cancelingVentaId === venta.id" class="spinner-border spinner-border-sm"></span>
                      </button>
                    </ng-container>

                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="!isLoading && (!ventasPage || ventasPage.content.length === 0)" class="empty-container flex-grow-1 d-flex align-items-center justify-content-center">
          <div class="alert masterserv-alert-info text-center">
            <i class="bi bi-info-circle me-2"></i> No se encontraron ventas con los filtros seleccionados.
          </div>
        </div>

        <div class="card-footer bg-transparent border-top border-secondary d-flex justify-content-between align-items-center py-2" 
             *ngIf="!isLoading && ventasPage && ventasPage.totalPages > 1">
          
          <button class="btn masterserv-btn-secondary btn-sm" (click)="paginaAnterior()" [disabled]="ventasPage.first">
            <i class="bi bi-chevron-left"></i> Anterior
          </button>

          <span class="text-white-50 small">
            PÃ¡gina <strong class="text-warning">{{ ventasPage.number + 1 }}</strong> de <strong class="text-white">{{ ventasPage.totalPages }}</strong>
            <span class="d-none d-md-inline text-light"> (Total: {{ ventasPage.totalElements }} ventas)</span>
          </span>

          <button class="btn masterserv-btn-secondary btn-sm" (click)="paginaSiguiente()" [disabled]="ventasPage.last">
            Siguiente <i class="bi bi-chevron-right"></i>
          </button>
        </div>

      </div>
    </div>
  </div>
</div>