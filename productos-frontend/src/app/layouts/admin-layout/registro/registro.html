<div class="registro-container" *appHasPermission="'USUARIOS_MANAGE'">
  <div class="row justify-content-center">
    <div class="col-md-10 col-lg-9"> 
      <div class="card masterserv-card shadow-sm">
        <div class="card-header masterserv-card-header">
          <h4 class="masterserv-title mb-0">{{ pageTitle }}</h4>
        </div>
        <div class="card-body masterserv-card-body p-4 p-md-5">
          
          <form [formGroup]="userForm" (ngSubmit)="onSubmit()">

            <p class="masterserv-label-group">Información Personal</p>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="nombre" class="form-label masterserv-label">Nombre <span class="text-danger">*</span></label>
                <input type="text" id="nombre" class="form-control masterserv-input" formControlName="nombre"
                       (input)="validarInputTexto($event)"
                       [ngClass]="{ 'is-invalid': f['nombre'].invalid && f['nombre'].touched }">
                <div *ngIf="f['nombre'].invalid && f['nombre'].touched" class="invalid-feedback">
                  <div *ngIf="f['nombre'].errors?.['required']">Obligatorio.</div>
                  <div *ngIf="f['nombre'].errors?.['minlength']">Mínimo 2 caracteres.</div>
                  <div *ngIf="f['nombre'].errors?.['pattern']">Solo letras.</div>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="apellido" class="form-label masterserv-label">Apellido <span class="text-danger">*</span></label>
                <input type="text" id="apellido" class="form-control masterserv-input" formControlName="apellido"
                       (input)="validarInputTexto($event)"
                       [ngClass]="{ 'is-invalid': f['apellido'].invalid && f['apellido'].touched }">
                <div *ngIf="f['apellido'].invalid && f['apellido'].touched" class="invalid-feedback">
                  <div *ngIf="f['apellido'].errors?.['required']">Obligatorio.</div>
                  <div *ngIf="f['apellido'].errors?.['pattern']">Solo letras.</div>
                </div>
              </div>
            </div>

            <p class="masterserv-label-group mt-2">Identificación</p>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="tipoDocumentoId" class="form-label masterserv-label">Tipo Doc. <span class="text-danger">*</span></label>
                <select id="tipoDocumentoId" class="form-select masterserv-input" formControlName="tipoDocumentoId"
                        [ngClass]="{ 'is-invalid': f['tipoDocumentoId'].invalid && f['tipoDocumentoId'].touched }">
                  <option [ngValue]="null" disabled>Seleccione...</option>
                  <option *ngFor="let td of tiposDocumento" [ngValue]="td.id">{{ td.nombreCorto }}</option>
                </select>
                <div *ngIf="f['tipoDocumentoId'].invalid && f['tipoDocumentoId'].touched" class="invalid-feedback">
                  <div *ngIf="f['tipoDocumentoId'].errors?.['required']">Obligatorio.</div>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="documento" class="form-label masterserv-label">Documento <span class="text-danger">*</span></label>
                <input type="text" id="documento" class="form-control masterserv-input" formControlName="documento"
                       [maxlength]="maxDocumentoLength"
                       (input)="validarInputNumerico($event)"
                       [ngClass]="{ 'is-invalid': f['documento'].invalid && f['documento'].touched }">
                
                <div *ngIf="f['documento'].touched && f['documento'].errors" class="invalid-feedback">
                  <div *ngIf="f['documento'].errors?.['required']">Obligatorio.</div>
                  <div *ngIf="selectedTipoDocNombre === 'DNI' && f['documento'].errors?.['minlength']">Mínimo 7 dígitos.</div>
                  <div *ngIf="selectedTipoDocNombre === 'CUIT' && f['documento'].errors?.['minlength']">Debe tener 11 dígitos.</div>
                </div>
              </div>
            </div>

            <hr class="my-3 border-metal">

            <p class="masterserv-label-group">Acceso al Sistema</p>
            
            <div class="mb-3">
              <label for="email" class="form-label masterserv-label">Email <span class="text-danger">*</span></label>
              <input type="email" id="email" class="form-control masterserv-input" formControlName="email"
                     [ngClass]="{ 'is-invalid': f['email'].invalid && f['email'].touched }">
              <div *ngIf="f['email'].invalid && f['email'].touched" class="invalid-feedback">
                <div *ngIf="f['email'].errors?.['required']">Obligatorio.</div>
                <div *ngIf="f['email'].errors?.['pattern']">Formato inválido.</div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="telefono" class="form-label masterserv-label">Teléfono <span class="text-danger">*</span></label>
              
              <div class="input-group">
                  <select class="form-select masterserv-input" formControlName="codigoPais" style="max-width: 120px;">
                      <option *ngFor="let pais of paises" [value]="pais.codigo">
                          {{ pais.bandera }} {{ pais.codigo }}
                      </option>
                  </select>
                  <input type="tel" id="telefono" class="form-control masterserv-input" formControlName="telefono"
                         (input)="validarInputNumerico($event)"
                         maxlength="15"
                         placeholder="Sin 0 ni 15"
                         [ngClass]="{ 'is-invalid': f['telefono'].invalid && f['telefono'].touched }">
              </div>
              <div *ngIf="f['telefono'].invalid && f['telefono'].touched" class="invalid-feedback d-block">
                <div *ngIf="f['telefono'].errors?.['required']">Obligatorio.</div>
                <div *ngIf="f['telefono'].errors?.['minlength']">Mínimo 8 dígitos.</div>
              </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="password" class="form-label masterserv-label">Contraseña <span class="text-danger" *ngIf="!esEdicion">*</span></label>
                    <div class="input-group">
                        <input [type]="hidePassword ? 'password' : 'text'" 
                               id="password" class="form-control masterserv-input" formControlName="password"
                               [placeholder]="esEdicion ? '(Dejar vacío para no cambiar)' : ''"
                               [ngClass]="{ 'is-invalid': f['password'].invalid && f['password'].touched }">
                        <button class="btn btn-outline-secondary masterserv-input" type="button" (click)="togglePasswordVisibility()">
                            <i class="bi" [ngClass]="hidePassword ? 'bi-eye-slash' : 'bi-eye'"></i>
                        </button>
                        <div *ngIf="f['password'].invalid && f['password'].touched" class="invalid-feedback">
                          <div *ngIf="f['password'].errors?.['required']">Obligatoria.</div>
                          <div *ngIf="f['password'].errors?.['minlength']">Mínimo 8 caracteres.</div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-3" *ngIf="!esEdicion || f['password'].value">
                    <label for="confirmPassword" class="form-label masterserv-label">Repetir Contraseña <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <input [type]="hideConfirmPassword ? 'password' : 'text'" 
                               id="confirmPassword" class="form-control masterserv-input" formControlName="confirmPassword"
                               [ngClass]="{ 'is-invalid': (f['confirmPassword'].invalid || userForm.errors?.['mismatch']) && f['confirmPassword'].touched }">
                        <button class="btn btn-outline-secondary masterserv-input" type="button" (click)="toggleConfirmPasswordVisibility()">
                            <i class="bi" [ngClass]="hideConfirmPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
                        </button>
                        <div class="invalid-feedback" *ngIf="f['confirmPassword'].errors?.['required']">
                            Requerido.
                        </div>
                        <div class="invalid-feedback" *ngIf="userForm.errors?.['mismatch']">
                            Las contraseñas no coinciden.
                        </div>
                    </div>
                </div>
            </div>

            <hr class="my-3 border-metal">

            <p class="masterserv-label-group">Permisos del Sistema</p>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="rolId" class="form-label masterserv-label">Asignar Rol <span class="text-danger">*</span></label>
                <select id="rolId" class="form-select masterserv-input" formControlName="rolId"
                        [ngClass]="{ 'is-invalid': f['rolId'].invalid && f['rolId'].touched }">
                  <option [ngValue]="null" disabled>Seleccione un Rol...</option>
                  <option *ngFor="let rol of roles" [ngValue]="rol.id">{{ rol.nombreRol | slice:5 }}</option>
                </select>
                <div *ngIf="f['rolId'].invalid && f['rolId'].touched" class="invalid-feedback">
                  <div *ngIf="f['rolId'].errors?.['required']">El rol es obligatorio.</div>
                </div>
              </div>
              <div class="col-md-6 mb-3" *ngIf="esEdicion">
                <label for="estado" class="form-label masterserv-label">Estado <span class="text-danger">*</span></label>
                <select id="estado" class="form-select masterserv-input" formControlName="estado"
                        [ngClass]="{ 'is-invalid': f['estado'].invalid && f['estado'].touched }">
                  <option value="ACTIVO">Activo</option>
                  <option value="INACTIVO">Inactivo</option>
                  <option value="BLOQUEADO">Bloqueado</option>
                  <option value="PENDIENTE">Pendiente</option>
                </select>
              </div>
            </div>

            <div *ngIf="errorMessage" class="alert masterserv-alert-danger p-2 text-center mt-3">
              {{ errorMessage }}
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
              <button type="button" class="btn masterserv-btn-secondary me-md-2" [routerLink]="['/pos/usuarios']">Cancelar</button>
              <button type="submit" class="btn masterserv-btn-primary" [disabled]="userForm.invalid || isSubmitting">
                <span *ngIf="!isSubmitting">{{ esEdicion ? 'Actualizar Usuario' : 'Guardar Usuario' }}</span>
                <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              </button>
            </div>

          </form> 
        </div>
      </div>
    </div>
  </div>
</div>